<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Piano Dieta">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#3b82f6">
    <meta name="description" content="Piano alimentare settimanale con AI per dieta LOW-FODMAP e senza glutine">

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.webmanifest">

    <!-- Icone per iOS -->
    <link rel="apple-touch-icon" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icon-512.png">

    <title>Piano Alimentare AI - Ambra</title>

    <!-- Preconnect per ottimizzazione -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdn.tailwindcss.com">

    <!-- Font con display=swap per evitare FOIT -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Tailwind CSS - caricato async per non bloccare il rendering -->
    <script src="https://cdn.tailwindcss.com" defer></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="./css/input.css">
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Schermata di caricamento -->
    <div id="loader" class="fixed inset-0 z-50 flex flex-col items-center justify-center hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
        <p class="mt-4 text-lg font-semibold text-gray-700" data-i18n="loading">L'IA sta creando il tuo piano personalizzato...</p>
    </div>

    <!-- Modale Configurazione API Key -->
    <div id="api-key-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8 max-w-2xl w-full m-2 sm:m-4 max-h-[95vh] overflow-y-auto">
            <h2 class="text-xl sm:text-2xl md:text-3xl font-bold mb-4 text-blue-600">üîë <span data-i18n="apiKeyTitle">Configurazione Impostazioni</span></h2>
            <p class="text-gray-600 mb-6 text-sm md:text-base" data-i18n="apiKeyDescription">Per utilizzare questo strumento, hai bisogno di una API Key gratuita di Google AI Studio.</p>

            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
                <h3 class="font-bold text-blue-900 mb-2" data-i18n="apiKeyHowTo">Come ottenere la tua API Key:</h3>
                <ol class="list-decimal list-inside text-sm text-blue-800 space-y-1">
                    <li><span data-i18n="apiKeyStep1">Vai su</span> <a href="https://makersuite.google.com/app/apikey" target="_blank" rel="noopener noreferrer" class="underline font-semibold hover:text-blue-600">Google AI Studio</a></li>
                    <li data-i18n="apiKeyStep2">Accedi con il tuo account Google</li>
                    <li data-i18n="apiKeyStep3">Clicca su "Create API Key"</li>
                    <li data-i18n="apiKeyStep4">Copia la chiave e incollala qui sotto</li>
                </ol>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="userName">Nome utente:</label>
                <input type="text" id="user-name-input" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Es: Ambra">
                <p class="mt-1 text-xs text-gray-500" data-i18n="userNameHelp">Inserisci il nome della persona per cui vuoi creare il piano alimentare</p>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="dailyCalories">Calorie giornaliere (kcal):</label>
                <input type="number" id="daily-calories-input" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="1500" min="1000" max="3000" step="50">
                <p class="mt-1 text-xs text-gray-500" data-i18n="dailyCaloriesHelp">Obiettivo calorico giornaliero per il piano alimentare (es: 1500-1600)</p>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold text-gray-700 mb-2" data-i18n="apiKeyLabel">API Key di Google AI Studio:</label>
                <input type="password" id="api-key-input" class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition font-mono text-sm" placeholder="AIza...">
                <button type="button" id="toggle-api-key-visibility" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                    <span id="show-hide-text">üëÅÔ∏è <span data-i18n="apiKeyShow">Mostra</span></span>
                </button>
            </div>

            <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6 rounded">
                <p class="text-sm text-yellow-800" data-i18n="apiKeyWarning">
                    <strong>‚ö†Ô∏è Importante:</strong> La tua API Key viene salvata solo nel tuo browser (localStorage) e non viene mai condivisa. Ogni utente deve inserire la propria chiave personale.
                </p>
            </div>

            <div class="flex justify-end gap-4">
                <button id="cancel-api-key-btn" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 font-semibold" data-i18n="cancel">Annulla</button>
                <button id="save-api-key-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold shadow-lg">üíæ <span data-i18n="saveApiKey">Salva Impostazioni</span></button>
            </div>

            <div class="mt-6 pt-6 border-t border-gray-200">
                <p class="text-xs text-gray-500 text-center" data-i18n="apiKeyFooter">
                    L'API Key √® necessaria per generare i piani alimentari con l'intelligenza artificiale di Google Gemini. √à gratuita e ha un limite generoso di richieste giornaliere.
                </p>
            </div>
        </div>
    </div>

    <!-- Modale Inserimento Ingredienti -->
    <div id="ingredients-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-40 hidden overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-4 sm:p-6 md:p-8 max-w-5xl w-full m-2 sm:m-4 max-h-[95vh] overflow-y-auto">
            <h2 class="text-xl sm:text-2xl font-bold mb-4" data-i18n="ingredientsManagement">Gestione Ingredienti</h2>
            <p class="text-gray-600 mb-4 text-sm md:text-base" data-i18n="ingredientsDescription">Inserisci gli ingredienti che hai a casa (con le quantit√†, es. "pollo 500g, uova 6"). L'IA creer√† un piano fino a esaurimento scorte.</p>

            <!-- Tabs per navigazione -->
            <div class="flex gap-1 sm:gap-2 mb-4 border-b-2 border-gray-200 overflow-x-auto">
                <button id="tab-manual" class="px-2 sm:px-4 py-2 font-semibold border-b-2 border-blue-500 text-blue-600 text-xs sm:text-sm whitespace-nowrap">‚úçÔ∏è <span data-i18n="tabManual">Inserimento Manuale</span></button>
                <button id="tab-history" class="px-2 sm:px-4 py-2 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-xs sm:text-sm whitespace-nowrap">üìú <span data-i18n="tabHistory">Storico Ingredienti</span></button>
                <button id="tab-shopping" class="px-2 sm:px-4 py-2 font-semibold border-b-2 border-transparent text-gray-500 hover:text-gray-700 text-xs sm:text-sm whitespace-nowrap">üõí <span data-i18n="tabShopping">Lista Spesa</span></button>
            </div>

            <!-- Tab Inserimento Manuale -->
            <div id="content-manual" class="tab-content">
                <!-- Lista ingredienti salvati -->
                <div id="saved-ingredients-section" class="mb-4 hidden">
                    <h3 class="font-semibold mb-2 text-gray-700" data-i18n="savedLists">Liste Salvate:</h3>
                    <div id="saved-ingredients-list" class="flex flex-wrap gap-2 mb-2">
                        <!-- I pulsanti delle liste salvate verranno inseriti qui -->
                    </div>
                </div>

                <div class="mb-2 flex justify-between items-center">
                    <label class="text-sm text-gray-600" data-i18n="ingredientsAvailableLabel">Ingredienti disponibili:</label>
                    <button id="load-example-btn" class="text-xs text-blue-600 hover:text-blue-800 font-semibold">üìã <span data-i18n="loadExample">Carica esempio</span></button>
                </div>

                <textarea id="ingredients-input" class="w-full h-48 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" data-i18n="ingredientsPlaceholder" placeholder="Es: petto di pollo 500g, riso basmati 1kg, zucchine 3, pomodori 250g, uova 6..."></textarea>

                <div class="mt-4 flex gap-2">
                    <input id="list-name-input" type="text" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" data-i18n="listNamePlaceholder" placeholder="Nome lista (opzionale)">
                    <button id="save-list-btn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">üíæ <span data-i18n="saveList">Salva Lista</span></button>
                </div>
            </div>

            <!-- Tab Storico Ingredienti -->
            <div id="content-history" class="tab-content hidden">
                <div class="mb-4">
                    <input id="search-history" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" data-i18n="searchIngredient" placeholder="üîç Cerca ingrediente...">
                </div>
                <div class="mb-2 flex justify-between items-center">
                    <h3 class="font-semibold text-gray-700" data-i18n="previousIngredients">Ingredienti usati in precedenza:</h3>
                    <button id="clear-history-btn" class="text-xs text-red-600 hover:text-red-800" data-i18n="clearHistory">Cancella storico</button>
                </div>
                <div id="history-items" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-96 overflow-y-auto">
                    <!-- Gli ingredienti storici verranno inseriti qui -->
                </div>
            </div>

            <!-- Tab Lista Spesa -->
            <div id="content-shopping" class="tab-content hidden">
                <div class="mb-4">
                    <input id="search-shopping" type="text" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" data-i18n="searchToBuy" placeholder="üîç Cerca ingrediente da acquistare...">
                </div>
                <div class="mb-2">
                    <h3 class="font-semibold text-gray-700" data-i18n="suggestedIngredients">Ingredienti suggeriti dall'IA:</h3>
                    <p class="text-sm text-gray-500" data-i18n="shoppingTabDesc">Clicca su un ingrediente per segnarlo come acquistato e aggiungerlo al tuo inventario</p>
                </div>
                <div id="shopping-items-modal" class="grid grid-cols-1 gap-2 max-h-96 overflow-y-auto">
                    <!-- Gli ingredienti da acquistare verranno inseriti qui -->
                </div>
            </div>

            <div class="mt-6 flex justify-end gap-4">
                <button id="close-modal-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300" data-i18n="close">Chiudi</button>
                <button id="generate-with-ai-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 shadow" data-i18n="generatePlan">Genera Piano</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        
        <header class="text-center mb-8">
            <div class="flex justify-end mb-2">
                <div id="language-switcher" class="flex gap-1 bg-gray-100 rounded-lg p-1">
                    <button type="button" id="lang-it" class="lang-btn px-3 py-1 rounded text-sm font-semibold transition-colors" onclick="setLanguage('it')">üáÆüáπ IT</button>
                    <button type="button" id="lang-en" class="lang-btn px-3 py-1 rounded text-sm font-semibold transition-colors" onclick="setLanguage('en')">üá¨üáß EN</button>
                </div>
            </div>
            <h1 id="app-title" class="text-2xl sm:text-3xl md:text-5xl font-bold text-blue-600 leading-tight"><span data-i18n="mealPlanFor">Piano Alimentare di</span> <span id="user-name-display">Ambra</span></h1>
            <p class="text-gray-500 mt-2 text-sm md:text-base" data-i18n="appSubtitle">Un piano personalizzato, vario e gustoso per ogni settimana.</p>
            <div class="mt-4 flex flex-wrap justify-center gap-4 text-sm">
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-blue-100 border border-gray-300 rounded"></div>
                    <span data-i18n="ingredientsAvailable">Ingredienti disponibili</span>
                </div>
                <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-orange-100 border-2 border-orange-400 rounded"></div>
                    <span>üõí <span data-i18n="ingredientsToPurchase">Ingredienti da acquistare</span></span>
                </div>
            </div>
        </header>

        <!-- Modal Selezione Pasto -->
        <div id="meal-selection-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-md m-4">
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6 rounded-t-2xl">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold flex items-center gap-3">
                            <span class="text-3xl">üë®‚Äçüç≥</span>
                            <span data-i18n="chooseMeal">Scegli il Pasto</span>
                        </h2>
                        <button type="button" id="close-meal-selection-btn" class="text-white hover:text-gray-200 text-3xl font-bold transition">&times;</button>
                    </div>
                    <p class="mt-2 text-purple-100 text-sm" data-i18n="chooseMealDesc">Seleziona per quale pasto vuoi generare le ricette</p>
                </div>

                <div class="p-6 space-y-4">
                    <button
                        type="button"
                        onclick="selectMealAndGenerate('lunch')"
                        class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-white font-bold py-6 px-6 rounded-xl shadow-lg transition-all transform hover:scale-105 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <span class="text-5xl">üçù</span>
                            <div class="text-left">
                                <div class="text-2xl font-bold" data-i18n="lunch">Pranzo</div>
                                <div class="text-sm opacity-90" data-i18n="lunchRecipes">Ricette per il mezzogiorno</div>
                            </div>
                        </div>
                        <span class="text-2xl">‚Üí</span>
                    </button>

                    <button
                        type="button"
                        onclick="selectMealAndGenerate('dinner')"
                        class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white font-bold py-6 px-6 rounded-xl shadow-lg transition-all transform hover:scale-105 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <span class="text-5xl">üçΩÔ∏è</span>
                            <div class="text-left">
                                <div class="text-2xl font-bold" data-i18n="dinner">Cena</div>
                                <div class="text-sm opacity-90" data-i18n="dinnerRecipes">Ricette per la sera</div>
                            </div>
                        </div>
                        <span class="text-2xl">‚Üí</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal Ricette AI -->
        <div id="recipes-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden overflow-y-auto">
            <div class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-4xl max-h-[90vh] overflow-y-auto m-4">
                <div class="sticky top-0 bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6 rounded-t-2xl z-10">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl md:text-3xl font-bold flex items-center gap-3">
                            <span class="text-3xl">üë®‚Äçüç≥</span>
                            <span data-i18n="dailyRecipes">Ricette AI del Giorno</span>
                        </h2>
                        <div class="flex items-center gap-2">
                            <button
                                type="button"
                                id="share-recipes-btn"
                                class="bg-white bg-opacity-20 hover:bg-opacity-30 text-white px-4 py-2 rounded-lg transition-all flex items-center gap-2"
                                data-i18n-title="shareRecipes"
                                title="Condividi ricette">
                                <span class="text-xl">üì§</span>
                                <span class="hidden md:inline" data-i18n="share">Condividi</span>
                            </button>
                            <button type="button" id="close-recipes-btn" class="text-white hover:text-gray-200 text-3xl font-bold transition">&times;</button>
                        </div>
                    </div>
                    <p class="mt-2 text-purple-100 text-sm" id="recipes-day-info"></p>
                </div>

                <div class="p-6">
                    <!-- Loader -->
                    <div id="recipes-loader" class="hidden text-center py-12">
                        <div class="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-purple-500 mb-4"></div>
                        <p class="text-lg text-gray-600 font-semibold" data-i18n="generatingRecipes">ü§ñ L'AI sta creando ricette deliziose...</p>
                        <p class="text-sm text-gray-500 mt-2" data-i18n="analyzingIngredients">Analizzando gli ingredienti del giorno...</p>
                    </div>

                    <!-- Contenuto ricette -->
                    <div id="recipes-content" class="space-y-6">
                        <!-- Le ricette verranno inserite qui -->
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-col gap-4 mb-6">
            <div id="week-navigation" class="flex flex-wrap justify-center gap-2">
                <!-- I pulsanti delle settimane verranno inseriti qui da JS -->
            </div>
            <div class="grid grid-cols-2 md:flex md:flex-row gap-2 justify-center">
                <button id="open-settings-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-3 md:px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 text-sm md:text-base" title="Gestisci API Key">
                    ‚öôÔ∏è <span data-i18n="settings" class="hidden sm:inline">Impostazioni</span>
                </button>
                <button onclick="printWeeklyPlan()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 md:px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 text-sm md:text-base" title="Stampa Piano">
                    üñ®Ô∏è <span data-i18n="print" class="hidden sm:inline">Stampa</span>
                </button>
                <button id="clear-plan-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 md:px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 text-sm md:text-base" title="Cancella piano salvato">
                    üóëÔ∏è <span data-i18n="clearPlan" class="hidden sm:inline">Cancella Piano</span>
                </button>
                <button id="open-modal-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 md:px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 text-sm md:text-base col-span-2 md:col-span-1">
                    <span data-i18n="modifyIngredients">Modifica Ingredienti</span>
                </button>
            </div>
        </div>

        <div id="day-navigation" class="flex flex-wrap justify-center border-b-2 border-gray-200 mb-6 gap-2">
            <!-- I tab dei giorni verranno inseriti qui da JS -->
        </div>
        
        <main>
            <div id="meals-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8"></div>
            <div id="daily-summary" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 mb-8"></div>

            <!-- Lista della Spesa -->
            <div id="shopping-list-container" class="bg-gradient-to-br from-orange-50 to-orange-100 p-6 rounded-2xl shadow-lg border-2 border-orange-300 mb-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-orange-800">üõí <span data-i18n="shoppingListTitle">Lista della Spesa</span></h2>
                    <button id="toggle-shopping-btn" class="text-sm text-orange-700 hover:text-orange-900 font-semibold"><span data-i18n="hide">Nascondi</span> ‚ñ≤</button>
                </div>
                <div id="shopping-list-content">
                    <p class="text-sm text-orange-700 mb-3" data-i18n="shoppingListSubtitle">Ingredienti suggeriti dall'IA per completare il piano alimentare:</p>
                    <div id="shopping-items" class="bg-white rounded-lg p-4 shadow-inner">
                        <!-- Gli ingredienti da acquistare verranno inseriti qui -->
                    </div>
                </div>
            </div>

            <!-- Tabella ingredienti -->
            <div id="ingredients-table-container" class="bg-white p-6 rounded-2xl shadow-lg border border-gray-200 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-700">üì¶ <span data-i18n="inventoryTitle">Inventario Ingredienti</span></h2>
                    <div class="flex gap-2">
                        <button type="button" id="refresh-inventory-btn" class="text-sm px-3 py-1 bg-green-500 hover:bg-green-600 text-white rounded font-semibold" title="Ricalcola inventario dal piano">
                            üîÑ <span data-i18n="refresh">Aggiorna</span>
                        </button>
                        <button type="button" id="toggle-table-btn" class="text-sm text-blue-600 hover:text-blue-800 font-semibold"><span data-i18n="hide">Nascondi</span> ‚ñ≤</button>
                    </div>
                </div>
                <div id="ingredients-summary" class="mb-4 p-3 bg-blue-50 rounded-lg"></div>
                <div id="ingredients-table-content">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-gradient-to-r from-gray-100 to-gray-200">
                                    <th class="p-2 md:p-4 font-bold border-b-2 border-gray-300 text-gray-800 text-xs md:text-sm">
                                        <button onclick="sortInventory('name')" class="flex items-center gap-1 hover:text-blue-600 transition">
                                            <span data-i18n="ingredient">Ingrediente</span>
                                            <span id="sort-icon-name" class="text-xs">‚áÖ</span>
                                        </button>
                                    </th>
                                    <th class="p-2 md:p-4 font-bold border-b-2 border-gray-300 text-right text-gray-800 text-xs md:text-sm">
                                        <button onclick="sortInventory('initial')" class="flex items-center gap-1 ml-auto hover:text-blue-600 transition">
                                            <span data-i18n="initialQuantity" class="hidden md:inline">Quantit√† Iniziale</span>
                                            <span class="md:hidden">Qt√† Init.</span>
                                            <span id="sort-icon-initial" class="text-xs">‚áÖ</span>
                                        </button>
                                    </th>
                                    <th class="p-2 md:p-4 font-bold border-b-2 border-gray-300 text-right text-gray-800 text-xs md:text-sm" data-i18n="consumed">
                                        <span class="hidden md:inline">Consumato</span>
                                        <span class="md:hidden">Cons.</span>
                                    </th>
                                    <th class="p-2 md:p-4 font-bold border-b-2 border-gray-300 text-right text-gray-800 text-xs md:text-sm">
                                        <button onclick="sortInventory('remaining')" class="flex items-center gap-1 ml-auto hover:text-blue-600 transition">
                                            <span data-i18n="remaining" class="hidden md:inline">Rimanente</span>
                                            <span class="md:hidden">Riman.</span>
                                            <span id="sort-icon-remaining" class="text-xs">‚áÖ</span>
                                        </button>
                                    </th>
                                    <th class="p-2 md:p-4 font-bold border-b-2 border-gray-300 text-center text-gray-800 text-xs md:text-sm">
                                        <button onclick="sortInventory('status')" class="flex items-center gap-1 mx-auto hover:text-blue-600 transition">
                                            <span data-i18n="status">Stato</span>
                                            <span id="sort-icon-status" class="text-xs">‚áÖ</span>
                                        </button>
                                    </th>
                                    <th class="p-2 md:p-4 font-bold border-b-2 border-gray-300 text-center text-gray-800 text-xs md:text-sm">
                                        <span data-i18n="actions" class="hidden md:inline">Azioni</span>
                                        <span class="md:hidden">‚úèÔ∏è</span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="ingredients-table-body">
                                <!-- Le righe verranno inserite qui da JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
        
    </div>

    <script>
        // ==============================================================================
        // 1. CONFIGURAZIONE
        // ==============================================================================
        // DAYS e MEALS vengono mantenuti in italiano per compatibilit√† con il piano generato dall'IA
        // Le traduzioni vengono gestite tramite funzioni helper
        const DAYS_IT = ["Luned√¨", "Marted√¨", "Mercoled√¨", "Gioved√¨", "Venerd√¨", "Sabato", "Domenica"];
        const MEALS_IT = ["Colazione", "Spuntino Mattina", "Pranzo", "Spuntino Pomeriggio", "Cena"];

        let DAYS = [...DAYS_IT];  // Copia per compatibilit√† con codice esistente
        let MEALS = [...MEALS_IT]; // Copia per compatibilit√† con codice esistente

        const MEAL_COLORS = {
            "Colazione": "bg-blue-100", "Spuntino Mattina": "bg-green-100", "Pranzo": "bg-yellow-100", "Spuntino Pomeriggio": "bg-green-100", "Cena": "bg-purple-100",
        };

        let fullPlan = []; // L'intero piano di 1 settimana verr√† memorizzato qui
        let currentState = { week: 0, day: DAYS[0] };
        let ingredientsInventory = {}; // Traccia ingredienti: {nome: {initial: X, consumed: Y}}
        let inventorySortBy = 'name'; // Opzioni: 'name', 'remaining', 'status', 'initial'
        let inventorySortOrder = 'asc'; // 'asc' o 'desc'

        // ==============================================================================
        // PERFORMANCE UTILITIES
        // ==============================================================================

        // Debounce function - ottimizza funzioni chiamate frequentemente
        const debounce = (func, delay = 300) => {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        };

        // Cache per calcoli pesanti
        const calculationCache = new Map();
        const getCachedResult = (key, calculationFn) => {
            if (calculationCache.has(key)) {
                console.log(`[CACHE] Hit for: ${key}`);
                return calculationCache.get(key);
            }
            const result = calculationFn();
            calculationCache.set(key, result);
            return result;
        };
        const clearCalculationCache = () => {
            calculationCache.clear();
            console.log('[CACHE] Cleared');
        };

        // ==============================================================================
        // HELPER FUNCTIONS
        // ==============================================================================

        // Helper functions per tradurre giorni e pasti
        const translateDay = (dayIT) => {
            const dayMap = {
                "Luned√¨": typeof t === 'function' ? t('monday') : 'Luned√¨',
                "Marted√¨": typeof t === 'function' ? t('tuesday') : 'Marted√¨',
                "Mercoled√¨": typeof t === 'function' ? t('wednesday') : 'Mercoled√¨',
                "Gioved√¨": typeof t === 'function' ? t('thursday') : 'Gioved√¨',
                "Venerd√¨": typeof t === 'function' ? t('friday') : 'Venerd√¨',
                "Sabato": typeof t === 'function' ? t('saturday') : 'Sabato',
                "Domenica": typeof t === 'function' ? t('sunday') : 'Domenica'
            };
            return dayMap[dayIT] || dayIT;
        };

        const translateMeal = (mealIT) => {
            const mealMap = {
                "Colazione": typeof t === 'function' ? t('breakfast') : 'Colazione',
                "Spuntino Mattina": typeof t === 'function' ? t('morningSnack') : 'Spuntino Mattina',
                "Pranzo": typeof t === 'function' ? t('lunch') : 'Pranzo',
                "Spuntino Pomeriggio": typeof t === 'function' ? t('afternoonSnack') : 'Spuntino Pomeriggio',
                "Cena": typeof t === 'function' ? t('dinner') : 'Cena'
            };
            return mealMap[mealIT] || mealIT;
        };
        
        // ==============================================================================
        // 2. INTEGRAZIONE IA (GEMINI) + IMPOSTAZIONI UTENTE
        // ==============================================================================
        const API_KEY_STORAGE = 'gemini_api_key';
        const USER_NAME_STORAGE = 'user_name';
        const DAILY_CALORIES_STORAGE = 'daily_calories';
        const MEAL_PLAN_STORAGE = 'meal_plan';
        const INGREDIENTS_INVENTORY_STORAGE = 'ingredients_inventory';
        const CONFIRMED_INGREDIENTS_STORAGE = 'confirmed_ingredients'; // NUOVO: traccia ingredienti confermati

        const getApiKey = () => {
            return localStorage.getItem(API_KEY_STORAGE);
        };

        const saveApiKey = (key) => {
            localStorage.setItem(API_KEY_STORAGE, key);
        };

        const deleteApiKey = () => {
            localStorage.removeItem(API_KEY_STORAGE);
        };

        const getUserName = () => {
            return localStorage.getItem(USER_NAME_STORAGE) || 'Ambra';
        };

        const saveUserName = (name) => {
            localStorage.setItem(USER_NAME_STORAGE, name);
        };

        const getDailyCalories = () => {
            return parseInt(localStorage.getItem(DAILY_CALORIES_STORAGE)) || 1550;
        };

        const saveDailyCalories = (calories) => {
            localStorage.setItem(DAILY_CALORIES_STORAGE, calories);
        };

        // Salva il piano alimentare in localStorage
        const saveMealPlan = (plan) => {
            try {
                localStorage.setItem(MEAL_PLAN_STORAGE, JSON.stringify(plan));
                console.log('‚úÖ Piano alimentare salvato in localStorage');
            } catch (e) {
                console.error('‚ùå Errore nel salvare il piano:', e);
            }
        };

        // Recupera il piano alimentare da localStorage
        const loadMealPlan = () => {
            try {
                const saved = localStorage.getItem(MEAL_PLAN_STORAGE);
                if (saved) {
                    const plan = JSON.parse(saved);
                    console.log('‚úÖ Piano alimentare caricato da localStorage');
                    return plan;
                }
            } catch (e) {
                console.error('‚ùå Errore nel caricare il piano:', e);
            }
            return null;
        };

        // Salva l'inventario ingredienti in localStorage
        const saveIngredientsInventory = (inventory) => {
            try {
                localStorage.setItem(INGREDIENTS_INVENTORY_STORAGE, JSON.stringify(inventory));
            } catch (e) {
                console.error('‚ùå Errore nel salvare inventario:', e);
            }
        };

        // Recupera l'inventario ingredienti da localStorage
        const loadIngredientsInventory = () => {
            try {
                const saved = localStorage.getItem(INGREDIENTS_INVENTORY_STORAGE);
                if (saved) {
                    return JSON.parse(saved);
                }
            } catch (e) {
                console.error('‚ùå Errore nel caricare inventario:', e);
            }
            return {};
        };

        // Cancella il piano salvato (opzionale)
        const clearMealPlan = () => {
            localStorage.removeItem(MEAL_PLAN_STORAGE);
            localStorage.removeItem(INGREDIENTS_INVENTORY_STORAGE);
            localStorage.removeItem(CONFIRMED_INGREDIENTS_STORAGE);
            console.log('üóëÔ∏è Piano alimentare cancellato');
        };

        // NUOVO: Funzioni per gestire gli ingredienti confermati
        const getConfirmedIngredients = () => {
            try {
                const saved = localStorage.getItem(CONFIRMED_INGREDIENTS_STORAGE);
                return saved ? JSON.parse(saved) : [];
            } catch (e) {
                console.error('‚ùå Errore nel caricare ingredienti confermati:', e);
                return [];
            }
        };

        const addConfirmedIngredient = (ingredientName) => {
            const confirmed = getConfirmedIngredients();
            // Normalizza il nome per confronto
            const normalizedName = normalizeIngredientName(ingredientName);
            if (!confirmed.includes(normalizedName)) {
                confirmed.push(normalizedName);
                localStorage.setItem(CONFIRMED_INGREDIENTS_STORAGE, JSON.stringify(confirmed));
                console.log(`‚úÖ Ingrediente confermato aggiunto: "${normalizedName}"`);
            }
        };

        const isIngredientConfirmed = (ingredientName) => {
            const confirmed = getConfirmedIngredients();
            const normalizedName = normalizeIngredientName(ingredientName);
            return confirmed.includes(normalizedName);
        };

        const generateMealsWithAI = async (ingredients) => {
            const loader = document.getElementById('loader');
            loader.classList.remove('hidden');

            console.log("üöÄ Inizio generazione piano alimentare...");

            const apiKey = getApiKey();
            if (!apiKey || apiKey === "") {
                loader.classList.add('hidden');
                alert("‚ö†Ô∏è API Key non configurata!\n\nClicca su 'Impostazioni' per inserire la tua API Key di Google AI Studio.");
                document.getElementById('api-key-modal').classList.remove('hidden');
                return;
            }
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // Ottieni le impostazioni personalizzate
            const userName = getUserName();
            const dailyCalories = getDailyCalories();
            const calorieRange = `${dailyCalories - 50}-${dailyCalories + 50}`;

            const prompt = `
                ${typeof t === 'function' ? t('planPromptIntro') : 'Sei un nutrizionista esperto. Crea un piano alimentare di 1 settimana (7 giorni) per'} ${userName} ${typeof t === 'function' ? t('planPromptDiet') : 'che segue una dieta LOW-FODMAP e SENZA GLUTINE.'}

                ${typeof t === 'function' ? t('planPromptIngredients') : 'INGREDIENTI DISPONIBILI:'} ${ingredients}

                ${typeof t === 'function' ? t('planPromptCalories') : 'OBIETTIVO CALORICO:'} ${calorieRange} ${typeof t === 'function' ? t('planPromptCaloriesPerDay') : 'kcal al giorno totali'}

                ${typeof t === 'function' ? t('planPromptInstructions') : 'ISTRUZIONI:'}
                1. USA PRIMA gli ingredienti disponibili rispettando le quantit√† (aggiungi "fromAvailable": true)
                2. QUANDO FINISCONO, continua con ingredienti low-FODMAP suggeriti (aggiungi "fromAvailable": false)
                3. COMPLETA TUTTI I 7 GIORNI
                4. USA SEMPRE IL NOME ESATTO dell'ingrediente come scritto nella lista (es: "tomini con spek" non "tomino con speck")
                5. DISTRIBUZIONE CALORICA PER PASTO (${calorieRange} kcal totali al giorno):
                   - Colazione: ${Math.round(dailyCalories * 0.20)}-${Math.round(dailyCalories * 0.23)} kcal (carboidrati + proteine)
                   - Spuntino Mattina: ${Math.round(dailyCalories * 0.07)}-${Math.round(dailyCalories * 0.10)} kcal (frutta o yogurt, MAI solo limone!)
                   - Pranzo: ${Math.round(dailyCalories * 0.32)}-${Math.round(dailyCalories * 0.36)} kcal (proteine + carboidrati + verdure)
                   - Spuntino Pomeriggio: ${Math.round(dailyCalories * 0.07)}-${Math.round(dailyCalories * 0.10)} kcal (frutta, yogurt o frutta secca)
                   - Cena: ${Math.round(dailyCalories * 0.29)}-${Math.round(dailyCalories * 0.33)} kcal (proteine + verdure + pochi carboidrati)
                6. Varia le combinazioni per non ripetere gli stessi pasti

                Per ogni pasto fornisci:
                - "items": [{"name": "Nome ESATTO dalla lista", "quantity": grammi}]
                - "kcal", "P", "C", "F": valori numerici
                - "fromAvailable": true o false

                STRUTTURA JSON:
                {
                  "weekly_plan": [
                    {
                      "Luned√¨": {
                        "Colazione": { "items": [...], "kcal": 0, "P": 0, "C": 0, "F": 0, "fromAvailable": true },
                        "Spuntino Mattina": { "items": [...], "kcal": 0, "P": 0, "C": 0, "F": 0, "fromAvailable": true },
                        "Pranzo": { "items": [...], "kcal": 0, "P": 0, "C": 0, "F": 0, "fromAvailable": true },
                        "Spuntino Pomeriggio": { "items": [...], "kcal": 0, "P": 0, "C": 0, "F": 0, "fromAvailable": true },
                        "Cena": { "items": [...], "kcal": 0, "P": 0, "C": 0, "F": 0, "fromAvailable": true }
                      },
                      "Marted√¨": { ... },
                      "Mercoled√¨": { ... },
                      "Gioved√¨": { ... },
                      "Venerd√¨": { ... },
                      "Sabato": { ... },
                      "Domenica": { ... }
                    }
                  ]
                }

                ${typeof t === 'function' ? t('planPromptJsonOnly') : 'Rispondi SOLO con il JSON, senza altri testi.'}
            `;

            // FIX: Rimosso responseSchema per evitare l'errore di complessit√†.
            // La validazione della struttura viene delegata al prompt e al parsing del client.
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
            };
            
            try {
                console.log("üì§ Invio richiesta all'API Gemini...");
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                console.log("üì• Risposta ricevuta, status:", response.status);

                if (!response.ok) {
                    let errorDetails = `Status: ${response.status} - ${response.statusText}`;
                    try {
                        const errorText = await response.text();
                        console.error("‚ùå Raw API error response:", errorText);
                        const errorBody = JSON.parse(errorText);
                        errorDetails = errorBody?.error?.message || errorDetails;
                    } catch (e) {
                        console.error("‚ùå Impossibile parsare il corpo dell'errore API, probabilmente non √® JSON.");
                    }
                    throw new Error(`API Error: ${errorDetails}`);
                }

                const result = await response.json();
                console.log("üì¶ Risposta completa dell'IA:", result);

                if (!result.candidates || !result.candidates[0]?.content?.parts?.[0]?.text) {
                    console.error("‚ùå Struttura della risposta non valida:", result);
                    throw new Error("Risposta dell'IA non valida o vuota.");
                }

                const rawText = result.candidates[0].content.parts[0].text;
                console.log("üìÑ Testo raw dall'IA:", rawText.substring(0, 500) + "...");

                // Pulisce la risposta per renderla un JSON valido, rimuovendo eventuali markdown.
                const jsonText = rawText
                    .replace(/^```json\s*/, '')
                    .replace(/```$/, '')
                    .trim();

                console.log("üßπ Testo pulito (primi 500 caratteri):", jsonText.substring(0, 500) + "...");

                const parsedJson = JSON.parse(jsonText);
                console.log("‚úÖ JSON parsato con successo!");

                if (!parsedJson.weekly_plan) {
                     console.error("‚ùå Chiave 'weekly_plan' mancante. Struttura ricevuta:", Object.keys(parsedJson));
                     throw new Error("L'IA ha restituito un formato di dati non valido (chiave 'weekly_plan' mancante).");
                }

                fullPlan = parsedJson.weekly_plan;
                console.log("‚ú® Piano alimentare caricato con successo! Settimane:", fullPlan.length);

                // Invalida cache calcoli (piano cambiato)
                clearCalculationCache();

                // Salva il piano in localStorage
                saveMealPlan(fullPlan);

                // Calcola i consumi degli ingredienti
                calculateIngredientConsumption(ingredients);

                // Salva anche l'inventario
                saveIngredientsInventory(ingredientsInventory);

                renderUI();
                renderIngredientsTable();
                renderShoppingList();

            } catch (error) {
                console.error("‚ùå Errore durante la chiamata all'IA:", error);
                alert(`Si √® verificato un errore durante la generazione del piano: ${error.message}. Controlla la console per i dettagli.`);
            } finally {
                loader.classList.add('hidden');
            }
        };

        // ==============================================================================
        // 3. CALCOLO CONSUMI INGREDIENTI
        // ==============================================================================
        const normalizeIngredientName = (name) => {
            // Normalizza i nomi degli ingredienti per evitare duplicati
            return name.toLowerCase()
                .trim()
                .replace(/\s+/g, ' ')  // Normalizza spazi multipli
                .replace(/\(parte\)/gi, '')  // Rimuovi "(parte)"
                .replace(/\(monoporzione\)/gi, '')  // Rimuovi "(monoporzione)"
                .replace(/\blesse\b/gi, '')  // Rimuovi "lesse"
                .replace(/\bal forno\b/gi, '')  // Rimuovi "al forno"
                .replace(/\bfreschi?\b/gi, '')  // Rimuovi "freschi/e"
                .replace(/\bsecche?\b/gi, '')  // Normalizza secche/o
                .replace(/\(low fodmap\)/gi, '')  // Rimuovi "(low fodmap)"
                .replace(/\d+\s*da\s*$/gi, '')  // Rimuovi "X da" alla fine (es: "4 da")
                .replace(/seche/gi, 'secche')  // Correggi typo
                .trim();
        };

        const parseInitialIngredients = (ingredientsText) => {
            // Parse la stringa degli ingredienti per estrarre nome e quantit√†
            const ingredients = {};
            const lines = ingredientsText.split(',').map(s => s.trim());

            lines.forEach(line => {
                // Match pattern: "nome XXXg" o "nome XX kg" o "nome X"
                const match = line.match(/^(.+?)\s+(\d+(?:\.\d+)?)\s*(g|kg|l|ml)?$/i);
                if (match) {
                    let name = normalizeIngredientName(match[1]);
                    let quantity = parseFloat(match[2]);
                    const unit = match[3] ? match[3].toLowerCase() : 'g';

                    // Converti tutto in grammi
                    if (unit === 'kg') quantity *= 1000;
                    if (unit === 'l') quantity *= 1000; // Approssimazione

                    // Se l'ingrediente esiste gi√†, somma le quantit√†
                    if (ingredients[name]) {
                        ingredients[name] += quantity;
                    } else {
                        ingredients[name] = quantity;
                    }
                } else {
                    // Ingrediente senza quantit√† specificata, assumiamo qb (quanto basta = infinito)
                    const name = normalizeIngredientName(line.replace(/q\.?b\.?/gi, ''));
                    if (name) {
                        ingredients[name] = 999999; // Quantit√† virtualmente infinita per "qb"
                    }
                }
            });

            return ingredients;
        };

        const calculateIngredientConsumption = (initialIngredientsText) => {
            console.log("üîÑ Ricalcolo inventario completo...");

            // Cache key basata su input e fullPlan
            const cacheKey = `ingredients_${initialIngredientsText}_${JSON.stringify(fullPlan).substring(0, 100)}`;

            // Usa cache se disponibile
            const cachedInventory = calculationCache.get(cacheKey);
            if (cachedInventory) {
                console.log("[PERF] Using cached ingredient calculation");
                ingredientsInventory = cachedInventory;
                return ingredientsInventory;
            }

            // Parse gli ingredienti iniziali dal campo input (se presenti)
            const initialIngredients = initialIngredientsText ? parseInitialIngredients(initialIngredientsText) : {};

            // NUOVO: Inizializza l'inventario con TUTTI gli ingredienti del piano
            ingredientsInventory = {};

            // Prima passata: raccoglie TUTTI gli ingredienti dal piano
            fullPlan.forEach(week => {
                DAYS.forEach(day => {
                    const dayPlan = week[day];
                    if (!dayPlan) return;

                    MEALS.forEach(mealName => {
                        const meal = dayPlan[mealName];
                        if (!meal || !meal.items) return;

                        meal.items.forEach(item => {
                            const ingredientName = normalizeIngredientName(item.name);

                            // Inizializza l'ingrediente se non esiste
                            if (!ingredientsInventory[ingredientName]) {
                                // Se l'ingrediente √® nel campo input, usa quella quantit√†
                                // Altrimenti inizializza a 0 (verr√† calcolato dal consumo)
                                const initialQty = initialIngredients[ingredientName] || 0;
                                ingredientsInventory[ingredientName] = {
                                    initial: initialQty,
                                    consumed: 0,
                                    originalName: item.name // Mantieni il nome originale non normalizzato
                                };
                            }
                        });
                    });
                });
            });

            // Seconda passata: calcola i consumi (solo fromAvailable: true)
            fullPlan.forEach(week => {
                DAYS.forEach(day => {
                    const dayPlan = week[day];
                    if (!dayPlan) return;

                    MEALS.forEach(mealName => {
                        const meal = dayPlan[mealName];
                        if (!meal || !meal.items || !meal.fromAvailable) return;

                        meal.items.forEach(item => {
                            const ingredientName = normalizeIngredientName(item.name);
                            const qty = item.quantity || 0;

                            if (ingredientsInventory[ingredientName]) {
                                ingredientsInventory[ingredientName].consumed += qty;
                            }
                        });
                    });
                });
            });

            // Terza passata: per ingredienti con initial = 0, imposta initial = consumed
            // (cio√® ingredienti aggiunti dopo ma usati nel piano)
            Object.keys(ingredientsInventory).forEach(name => {
                if (ingredientsInventory[name].initial === 0) {
                    // Controlla se √® stato confermato
                    if (isIngredientConfirmed(ingredientsInventory[name].originalName)) {
                        // Se √® confermato, cerca quanto ne serve totale
                        let totalNeeded = 0;
                        fullPlan.forEach(week => {
                            DAYS.forEach(day => {
                                const dayPlan = week[day];
                                if (!dayPlan) return;
                                MEALS.forEach(mealName => {
                                    const meal = dayPlan[mealName];
                                    if (!meal || !meal.items) return;
                                    meal.items.forEach(item => {
                                        if (normalizeIngredientName(item.name) === name) {
                                            totalNeeded += item.quantity || 0;
                                        }
                                    });
                                });
                            });
                        });
                        ingredientsInventory[name].initial = totalNeeded;
                        console.log(`   ‚ÑπÔ∏è "${ingredientsInventory[name].originalName}": confermato, quantit√† totale necessaria: ${totalNeeded}g`);
                    }
                }
            });

            console.log("üìä Inventario completo calcolato:", ingredientsInventory);
            console.log(`   üì¶ Totale ingredienti nell'inventario: ${Object.keys(ingredientsInventory).length}`);

            // Salva in cache per riutilizzo
            calculationCache.set(cacheKey, ingredientsInventory);

            // Salva l'inventario aggiornato
            saveIngredientsInventory(ingredientsInventory);

            return ingredientsInventory;
        };

        const renderIngredientsTable = () => {
            const container = document.getElementById('ingredients-table-container');
            const tbody = document.getElementById('ingredients-table-body');
            const summary = document.getElementById('ingredients-summary');
            tbody.innerHTML = '';

            if (Object.keys(ingredientsInventory).length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');

            // NUOVO: Mostra TUTTI gli ingredienti (anche quelli senza initial definita)
            // Filtra solo quelli con quantit√† "qb" (infinita)
            let validIngredients = Object.entries(ingredientsInventory)
                .filter(([name, data]) => data.initial < 999999); // Escludi solo quelli con qb

            // Ordina in base alla selezione corrente
            validIngredients.sort((a, b) => {
                const [nameA, dataA] = a;
                const [nameB, dataB] = b;
                const remainingA = dataA.initial - dataA.consumed;
                const remainingB = dataB.initial - dataB.consumed;
                const percentageA = dataA.initial > 0 ? (remainingA / dataA.initial) * 100 : 0;
                const percentageB = dataB.initial > 0 ? (remainingB / dataB.initial) * 100 : 0;

                // Funzione helper per calcolare priorit√† stato
                const getStatusPriority = (data) => {
                    if (data.initial === 0) return 0; // Da definire - priorit√† massima
                    const remaining = data.initial - data.consumed;
                    const percentage = data.initial > 0 ? (remaining / data.initial) * 100 : 0;

                    if (remaining <= 0 || percentage < 20) return 1; // Esaurito (incluso 0)
                    if (percentage < 50) return 2; // Basso
                    return 3; // OK
                };

                let comparison = 0;
                switch (inventorySortBy) {
                    case 'name':
                        comparison = nameA.localeCompare(nameB);
                        break;
                    case 'initial':
                        comparison = dataA.initial - dataB.initial;
                        break;
                    case 'remaining':
                        comparison = remainingA - remainingB;
                        break;
                    case 'status':
                        // Ordina per priorit√† stato: Da definire ‚Üí Esaurito ‚Üí Basso ‚Üí OK
                        comparison = getStatusPriority(dataA) - getStatusPriority(dataB);
                        break;
                    default:
                        comparison = nameA.localeCompare(nameB);
                }

                return inventorySortOrder === 'asc' ? comparison : -comparison;
            });

            if (validIngredients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-gray-500">Nessun ingrediente con quantit√† definita</td></tr>';
                return;
            }

            // Calcola statistiche
            let totalOK = 0, totalLow = 0, totalOut = 0;

            validIngredients.forEach(([name, data]) => {
                const remaining = data.initial - data.consumed;
                const percentage = data.initial > 0 ? (remaining / data.initial) * 100 : 0;

                // Se initial = 0, considera come "da definire" (non conta nelle statistiche critiche)
                if (data.initial === 0) {
                    // Non conta nelle statistiche
                } else if (remaining <= 0 || percentage < 20) { // CAMBIATO: <= invece di <
                    totalOut++;
                } else if (percentage < 50) {
                    totalLow++;
                } else {
                    totalOK++;
                }
            });

            // Mostra riepilogo
            const totalIngredientsText = typeof t === 'function' ? t('totalIngredients') : 'Totale ingredienti';
            const statusOKText = typeof t === 'function' ? t('statusOK') : 'OK';
            const statusLowText = typeof t === 'function' ? t('statusLow') : 'Bassi';
            const statusOutText = typeof t === 'function' ? t('statusOut') : 'Esauriti';

            summary.innerHTML = `
                <div class="flex gap-4 justify-center text-sm">
                    <span class="font-semibold">${totalIngredientsText}: <strong>${validIngredients.length}</strong></span>
                    <span class="text-green-700">‚úì ${statusOKText}: <strong>${totalOK}</strong></span>
                    <span class="text-orange-700">‚ö° ${statusLowText}: <strong>${totalLow}</strong></span>
                    <span class="text-red-700">‚ö† ${statusOutText}: <strong>${totalOut}</strong></span>
                </div>
            `;

            // Formatta i valori per una migliore leggibilit√†
            const formatQty = (qty) => {
                if (qty >= 1000) return `${(qty / 1000).toFixed(2)} kg`;
                return `${Math.round(qty)} g`;
            };

            const statusOKFull = typeof t === 'function' ? t('statusOK') : 'OK';
            const statusLowFull = typeof t === 'function' ? t('statusLow') : 'Basso';
            const statusOutFull = typeof t === 'function' ? t('statusOut') : 'Esaurito';

            validIngredients.forEach(([name, data]) => {
                const remaining = data.initial - data.consumed;
                const percentage = data.initial > 0 ? (remaining / data.initial) * 100 : 0;

                let statusColor = 'bg-green-100 text-green-800 border border-green-300';
                let statusText = `‚úì ${statusOKFull}`;
                let rowClass = 'border-b border-gray-200 hover:bg-blue-50 transition-colors';
                let rowBg = '';

                // NUOVO: Gestisci ingredienti senza quantit√† iniziale
                let statusTextMobile = ''; // Versione compatta per mobile
                if (data.initial === 0) {
                    statusColor = 'bg-gray-100 text-gray-600 border border-gray-300';
                    statusText = `‚öôÔ∏è Da definire`;
                    statusTextMobile = `‚öôÔ∏è`;
                    rowClass = 'border-b border-gray-300 hover:bg-gray-100 transition-colors';
                    rowBg = 'bg-gray-50';
                } else if (remaining <= 0) { // CAMBIATO: <= invece di <
                    statusColor = 'bg-red-100 text-red-800 border border-red-400';
                    statusText = `‚ö† ${statusOutFull}`;
                    statusTextMobile = `‚ö†`;
                    rowClass = 'border-b border-red-200 hover:bg-red-50 transition-colors';
                    rowBg = 'bg-red-50';
                } else if (percentage < 20) {
                    statusColor = 'bg-orange-100 text-orange-800 border border-orange-400';
                    statusText = `‚ö† ${statusLowFull}`;
                    statusTextMobile = `‚ö†`;
                    rowClass = 'border-b border-orange-200 hover:bg-orange-50 transition-colors';
                    rowBg = 'bg-orange-50';
                } else if (percentage < 50) {
                    statusColor = 'bg-yellow-100 text-yellow-800 border border-yellow-400';
                    statusText = `‚ö° ${statusLowFull}`;
                    statusTextMobile = `‚ö°`;
                    rowClass = 'border-b border-yellow-200 hover:bg-yellow-50 transition-colors';
                    rowBg = 'bg-yellow-50';
                } else {
                    statusTextMobile = `‚úì`;
                }

                const safeId = name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
                const row = document.createElement('tr');
                row.className = `${rowClass} ${rowBg}`;
                row.innerHTML = `
                    <td class="p-3 md:p-4 capitalize font-semibold text-gray-800 text-sm md:text-base">${name}</td>
                    <td class="p-3 md:p-4 text-right">
                        <div id="view-${safeId}" class="font-mono text-gray-700 text-xs md:text-sm">
                            ${formatQty(data.initial)}
                        </div>
                        <div id="edit-${safeId}" class="hidden flex items-center gap-2 justify-end">
                            <input type="number" id="input-${safeId}" class="w-20 md:w-24 px-2 py-1 border border-gray-300 rounded text-xs md:text-sm text-right" value="${Math.round(data.initial)}" min="0">
                            <span class="text-xs text-gray-600">g</span>
                        </div>
                    </td>
                    <td class="p-3 md:p-4 text-right font-mono text-blue-700 font-semibold text-xs md:text-sm">${formatQty(data.consumed)}</td>
                    <td class="p-2 md:p-4 text-right font-mono font-bold text-base md:text-lg ${remaining < 0 ? 'text-red-700' : 'text-green-700'}">${formatQty(remaining)}</td>
                    <td class="p-2 md:p-4 text-center">
                        <span class="hidden md:inline-block px-4 py-2 rounded-full text-xs font-bold ${statusColor} shadow-sm" title="${statusText}">${statusText}</span>
                        <span class="md:hidden inline-block px-2 py-1 rounded-full text-base font-bold ${statusColor} shadow-sm" title="${statusText}">${statusTextMobile}</span>
                    </td>
                    <td class="p-2 md:p-4 text-center">
                        <button type="button" id="btn-edit-${safeId}" onclick="editIngredientQuantity('${name}', '${safeId}')" class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition" title="Modifica quantit√†">
                            ‚úèÔ∏è
                        </button>
                        <button type="button" id="btn-save-${safeId}" onclick="saveIngredientQuantity('${name}', '${safeId}')" class="hidden px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition" title="Salva">
                            ‚úì
                        </button>
                        <button type="button" id="btn-cancel-${safeId}" onclick="cancelEditIngredient('${safeId}', ${data.initial})" class="hidden px-3 py-1 bg-gray-400 text-white text-xs rounded hover:bg-gray-500 transition ml-1" title="Annulla">
                            ‚úó
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        };

        const renderShoppingList = () => {
            const container = document.getElementById('shopping-list-container');
            const itemsDiv = document.getElementById('shopping-items');

            // Raccogli tutti gli ingredienti suggeriti (fromAvailable: false)
            const suggestedIngredients = new Map(); // nome -> quantit√† totale

            fullPlan.forEach(week => {
                DAYS.forEach(day => {
                    const dayPlan = week[day];
                    if (!dayPlan) return;

                    MEALS.forEach(mealName => {
                        const meal = dayPlan[mealName];
                        if (!meal || !meal.items || meal.fromAvailable !== false) return;

                        meal.items.forEach(item => {
                            const name = item.name;
                            const qty = item.quantity || 0;

                            // NUOVO: Escludi gli ingredienti gi√† confermati
                            if (isIngredientConfirmed(name)) {
                                console.log(`   ‚è≠Ô∏è Ingrediente "${name}" gi√† confermato, escluso dalla lista spesa`);
                                return;
                            }

                            if (suggestedIngredients.has(name)) {
                                suggestedIngredients.set(name, suggestedIngredients.get(name) + qty);
                            } else {
                                suggestedIngredients.set(name, qty);
                            }
                        });
                    });
                });
            });

            if (suggestedIngredients.size === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');

            // Formatta i valori
            const formatQty = (qty) => {
                if (qty >= 1000) return `${(qty / 1000).toFixed(2)} kg`;
                return `${Math.round(qty)} g`;
            };

            // Converti in array e ordina alfabeticamente
            const sortedItems = Array.from(suggestedIngredients.entries())
                .sort((a, b) => a[0].localeCompare(b[0]));

            // Crea la lista HTML con pulsanti di conferma
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-3">';

            sortedItems.forEach(([name, qty]) => {
                const safeId = name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
                html += `
                    <div id="main-shop-${safeId}" class="flex items-center gap-3 p-3 bg-orange-50 border border-orange-200 rounded-lg hover:bg-orange-100 transition-colors">
                        <div class="flex-shrink-0 w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-white font-bold">
                            üõí
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800 capitalize text-sm">${name}</div>
                            <div class="text-xs text-gray-600 mb-2">Totale: <span class="font-mono font-bold text-orange-700">${formatQty(qty)}</span></div>
                            <div class="flex items-center gap-2">
                                <input type="number" id="main-qty-${safeId}" class="w-24 px-2 py-1 border border-gray-300 rounded text-sm" placeholder="Qt√†" value="${Math.round(qty)}">
                                <span class="text-xs text-gray-600">g</span>
                                <button class="px-3 py-1 bg-green-500 text-white text-xs font-semibold rounded hover:bg-green-600 transition" onclick="confirmFromMainList('${name}', '${safeId}')">
                                    ‚úì Conferma
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            // Aggiungi contatore totale
            const totalCount = sortedItems.length;
            const headerInfo = `
                <div class="mb-4 p-3 bg-white border-2 border-orange-300 rounded-lg">
                    <div class="text-center">
                        <span class="text-2xl font-bold text-orange-700">${totalCount}</span>
                        <span class="text-sm text-gray-600 ml-2">ingredient${totalCount === 1 ? 'e' : 'i'} da acquistare</span>
                    </div>
                </div>
            `;

            itemsDiv.innerHTML = headerInfo + html;
        };

        // ==============================================================================
        // 4. FUNZIONI DI RENDER DELL'INTERFACCIA
        // ==============================================================================
        const renderUI = () => {
            renderWeekNavigation();
            renderDayNavigation();
            renderDayContent();
        };

        const renderDayContent = () => {
            const grid = document.getElementById('meals-grid');
            const summary = document.getElementById('daily-summary');
            grid.innerHTML = '';
            summary.innerHTML = '';

            const dayPlan = fullPlan?.[currentState.week]?.[currentState.day];

            if (!dayPlan || Object.keys(dayPlan).length === 0) {
                const warningText = typeof t === 'function' ? t('warningNoPlan') : 'Nessun piano disponibile per questo giorno.';
                grid.innerHTML = `<div class="col-span-full empty-day"><p class="text-gray-500 text-lg">${warningText}</p></div>`;
                summary.innerHTML = '';
                return;
            }

            let dailyTotals = { kcal: 0, P: 0, C: 0, F: 0 };
            let hasSuggestedIngredients = false;

            MEALS.forEach(mealName => {
                const meal = dayPlan[mealName];

                if (!meal || !meal.items || !Array.isArray(meal.items)) return;

                const values = {
                    kcal: meal.kcal || 0,
                    P: meal.P || 0,
                    C: meal.C || 0,
                    F: meal.F || 0,
                };

                for (const key in dailyTotals) {
                    dailyTotals[key] += values[key];
                }

                // Controlla se questo pasto usa ingredienti suggeriti
                const isFromAvailable = meal.fromAvailable !== false; // Default true se non specificato
                if (!isFromAvailable) {
                    hasSuggestedIngredients = true;
                }

                const card = document.createElement('div');
                // Usa colore arancione per ingredienti suggeriti
                const bgColor = isFromAvailable ? MEAL_COLORS[mealName] : 'bg-orange-100';
                const borderColor = isFromAvailable ? 'border-gray-200' : 'border-orange-400';
                card.className = `meal-card ${bgColor} rounded-2xl p-6 shadow-sm border-2 ${borderColor}`;

                // NUOVO: Controlla quali ingredienti sono disponibili e quali mancano
                let missingIngredients = [];
                let availableIngredients = [];

                let foodListHtml = '';
                if (Array.isArray(meal.items)) {
                    foodListHtml = meal.items.map(item => {
                        if (typeof item !== 'object' || !item.name || typeof item.quantity === 'undefined') return '';
                        const { name: food, quantity: qty } = item;

                        // Controlla se l'ingrediente √® disponibile o confermato
                        const normalizedName = normalizeIngredientName(food);
                        const isAvailable = (ingredientsInventory[normalizedName] && ingredientsInventory[normalizedName].initial > 0) || isIngredientConfirmed(food);

                        // Aggiungi alla lista appropriata
                        if (!isFromAvailable) {
                            if (isAvailable || isIngredientConfirmed(food)) {
                                availableIngredients.push(food);
                            } else {
                                missingIngredients.push(food);
                            }
                        }

                        // Aggiungi indicatore visivo
                        let statusIcon = '';
                        if (!isFromAvailable) {
                            statusIcon = isAvailable || isIngredientConfirmed(food)
                                ? '<span class="text-green-600 font-bold mr-1" title="Disponibile">‚úì</span>'
                                : '<span class="text-orange-600 font-bold mr-1" title="Mancante">üõí</span>';
                        }

                        return `<li class="flex justify-between items-center">
                            <span class="flex items-center">${statusIcon}${food}</span>
                            <span class="font-medium text-gray-600">${qty}g</span>
                        </li>`;
                    }).join('');
                }

                // Aggiungi badge dettagliato se sono ingredienti suggeriti
                const ingredientsToPurchaseText = typeof t === 'function' ? t('ingredientsToPurchase') : 'Ingredienti da acquistare';
                let badge = '';
                if (!isFromAvailable) {
                    const totalIngredients = meal.items.length;
                    const missingCount = missingIngredients.length;
                    const availableCount = availableIngredients.length;

                    if (missingCount > 0) {
                        badge = `
                            <div class="mb-3">
                                <span class="inline-block bg-orange-500 text-white text-xs px-2 py-1 rounded-full mb-1">
                                    üõí ${missingCount} ingrediente${missingCount > 1 ? 'i' : ''} mancante${missingCount > 1 ? 'i' : ''}
                                </span>
                                ${availableCount > 0 ? `<span class="inline-block bg-green-500 text-white text-xs px-2 py-1 rounded-full mb-1 ml-1">‚úì ${availableCount} disponibile${availableCount > 1 ? 'i' : ''}</span>` : ''}
                            </div>
                        `;
                    } else {
                        badge = `<span class="inline-block bg-green-500 text-white text-xs px-2 py-1 rounded-full mb-2">‚úì Tutti gli ingredienti disponibili</span>`;
                    }
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            ${badge}
                        </div>
                        <button
                            onclick="regenerateMeal('${currentState.day}', '${mealName}')"
                            class="flex-shrink-0 ml-2 p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-transform transform hover:scale-110 text-sm"
                            title="Rigenera questo pasto">
                            üîÑ
                        </button>
                    </div>
                    <h3 class="text-xl font-bold mb-3 text-gray-700">${translateMeal(mealName)}</h3>
                    <ul class="space-y-2 mb-4">${foodListHtml}</ul>
                    <div class="text-xs text-center font-mono bg-white/50 rounded-md p-2 text-gray-600">
                        Kcal: ${values.kcal.toFixed(0)} | P: ${values.P.toFixed(1)}g | C: ${values.C.toFixed(1)}g | F: ${values.F.toFixed(1)}g
                    </div>
                `;
                grid.appendChild(card);
            });

            if (dailyTotals.kcal > 0) {
                // Aggiungi avviso se il giorno contiene ingredienti suggeriti
                const warningSuggestedText = typeof t === 'function' ? t('warningSuggestedIngredients') : 'Questo giorno contiene ingredienti suggeriti che non sono nella tua lista.';
                const warningBanner = hasSuggestedIngredients
                    ? `<div class="mb-4 p-3 bg-orange-100 border-l-4 border-orange-500 text-orange-800 rounded"><p class="font-semibold">‚ö†Ô∏è ${warningSuggestedText}</p></div>`
                    : '';

                const dailySummaryText = typeof t === 'function' ? t('dailySummary') : 'Riepilogo Giornaliero';
                const totalCaloriesText = typeof t === 'function' ? t('totalCalories') : 'Calorie Totali';
                const proteinsText = typeof t === 'function' ? t('proteins') : 'Proteine';
                const carbsText = typeof t === 'function' ? t('carbs') : 'Carboidrati';
                const fatsText = typeof t === 'function' ? t('fats') : 'Grassi';

                summary.innerHTML = `
                    ${warningBanner}
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-700">${dailySummaryText}</h2>
                        <button
                            type="button"
                            onclick="generateDailyRecipes()"
                            class="px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-semibold rounded-lg shadow-md transition-all transform hover:scale-105 flex items-center gap-2"
                            title="Genera ricette AI con gli ingredienti del giorno">
                            <span class="text-lg">üë®‚Äçüç≥</span>
                            <span class="hidden md:inline">Ricette AI</span>
                            <span class="md:hidden">AI</span>
                        </button>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div><p class="text-sm text-gray-500">${totalCaloriesText}</p><p class="text-3xl font-bold text-blue-600">${dailyTotals.kcal.toFixed(0)}</p></div>
                        <div><p class="text-sm text-gray-500">${proteinsText}</p><p class="text-3xl font-bold text-red-500">${dailyTotals.P.toFixed(1)}g</p></div>
                        <div><p class="text-sm text-gray-500">${carbsText}</p><p class="text-3xl font-bold text-yellow-500">${dailyTotals.C.toFixed(1)}g</p></div>
                        <div><p class="text-sm text-gray-500">${fatsText}</p><p class="text-3xl font-bold text-green-500">${dailyTotals.F.toFixed(1)}g</p></div>
                    </div>
                `;
            }
        };

        const renderWeekNavigation = () => {
            const nav = document.getElementById('week-navigation');
            nav.innerHTML = '';
            const numWeeks = fullPlan.length || 2;
            const weekText = typeof t === 'function' ? t('week') : 'Settimana';
            for (let i = 0; i < numWeeks; i++) {
                const btn = document.createElement('button');
                btn.textContent = `${weekText} ${i + 1}`;
                btn.className = `btn-nav px-4 py-2 rounded-lg transition ${currentState.week === i ? 'active' : 'bg-white hover:bg-blue-50'}`;
                btn.onclick = () => {
                    currentState.week = i;
                    renderUI();
                };
                nav.appendChild(btn);
            }
        };

        const renderDayNavigation = () => {
            const nav = document.getElementById('day-navigation');
            nav.innerHTML = '';
            DAYS_IT.forEach(day => {
                const tab = document.createElement('button');
                tab.textContent = translateDay(day);
                tab.className = `day-tab py-2 px-4 -mb-0.5 border-b-2 font-medium text-sm transition ${currentState.day === day ? 'active' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`;
                tab.onclick = () => {
                    currentState.day = day;
                    renderUI();
                };
                nav.appendChild(tab);
            });
        };

        // ==============================================================================
        // 5. GESTIONE SALVATAGGIO INGREDIENTI (localStorage)
        // ==============================================================================
        const STORAGE_KEY = 'ambra_ingredient_lists';

        const loadSavedLists = () => {
            const saved = localStorage.getItem(STORAGE_KEY);
            return saved ? JSON.parse(saved) : {};
        };

        const saveLists = (lists) => {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(lists));
        };

        const renderSavedLists = () => {
            const lists = loadSavedLists();
            const container = document.getElementById('saved-ingredients-list');
            const section = document.getElementById('saved-ingredients-section');
            container.innerHTML = '';

            if (Object.keys(lists).length === 0) {
                section.classList.add('hidden');
                return;
            }

            section.classList.remove('hidden');

            Object.entries(lists).forEach(([name, ingredients]) => {
                const btn = document.createElement('button');
                btn.className = 'px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded-lg text-sm flex items-center gap-2';
                btn.innerHTML = `
                    <span>${name}</span>
                    <span class="text-red-500 hover:text-red-700 font-bold" onclick="event.stopPropagation(); deleteList('${name}')">√ó</span>
                `;
                btn.onclick = () => {
                    document.getElementById('ingredients-input').value = ingredients;
                };
                container.appendChild(btn);
            });
        };

        window.deleteList = (name) => {
            if (confirm(`Vuoi eliminare la lista "${name}"?`)) {
                const lists = loadSavedLists();
                delete lists[name];
                saveLists(lists);
                renderSavedLists();
            }
        };

        // ==============================================================================
        // 5B. GESTIONE STORICO INGREDIENTI E LISTA SPESA
        // ==============================================================================
        const HISTORY_KEY = 'ambra_ingredients_history';

        const loadIngredientsHistory = () => {
            const saved = localStorage.getItem(HISTORY_KEY);
            return saved ? JSON.parse(saved) : {};
        };

        const saveIngredientsHistory = (history) => {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        };

        const addToHistory = (ingredientName, quantity) => {
            const history = loadIngredientsHistory();
            history[ingredientName] = {
                quantity: quantity,
                lastUsed: new Date().toISOString()
            };
            saveIngredientsHistory(history);
        };

        const updateCurrentIngredients = (newIngredients) => {
            // Aggiorna gli ingredienti dalla lista corrente e salva nello storico
            const parsedIngredients = parseInitialIngredients(newIngredients);
            Object.entries(parsedIngredients).forEach(([name, qty]) => {
                if (qty < 999999) { // Escludi ingredienti con quantit√† "qb"
                    addToHistory(name, qty);
                }
            });
        };

        const renderIngredientsHistory = (filterText = '') => {
            const historyDiv = document.getElementById('history-items');
            const history = loadIngredientsHistory();
            historyDiv.innerHTML = '';

            const sortedHistory = Object.entries(history)
                .sort((a, b) => new Date(b[1].lastUsed) - new Date(a[1].lastUsed))
                .filter(([name]) => name.toLowerCase().includes(filterText.toLowerCase()));

            if (sortedHistory.length === 0) {
                historyDiv.innerHTML = '<p class="col-span-2 text-center text-gray-500 py-8">Nessun ingrediente nello storico</p>';
                return;
            }

            sortedHistory.forEach(([name, data]) => {
                const card = document.createElement('div');
                card.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 hover:bg-blue-100 transition-colors';
                card.innerHTML = `
                    <div class="flex items-center justify-between mb-3">
                        <span class="font-semibold capitalize text-gray-800 text-sm">${name}</span>
                        <button class="text-red-500 hover:text-red-700 text-2xl leading-none" onclick="event.stopPropagation(); removeFromHistory('${name}')">&times;</button>
                    </div>
                    <div class="flex flex-col gap-2">
                        <div class="flex items-center gap-2">
                            <input type="number" id="qty-${name.replace(/\s+/g, '-')}" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm" placeholder="Quantit√†" value="${data.quantity}" onclick="event.stopPropagation()">
                            <span class="text-sm text-gray-600 font-medium">g</span>
                        </div>
                        <button class="w-full px-4 py-2 bg-green-500 text-white text-sm font-semibold rounded hover:bg-green-600" onclick="event.stopPropagation(); addIngredientToList('${name}', '${name.replace(/\s+/g, '-')}')">
                            + Aggiungi
                        </button>
                    </div>
                `;
                historyDiv.appendChild(card);
            });
        };

        window.removeFromHistory = (name) => {
            const history = loadIngredientsHistory();
            delete history[name];
            saveIngredientsHistory(history);
            renderIngredientsHistory(document.getElementById('search-history').value);
        };

        window.addIngredientToList = (ingredientName, id) => {
            const qtyInput = document.getElementById(`qty-${id}`);
            const quantity = parseInt(qtyInput.value) || 0;

            if (quantity <= 0) {
                alert('Inserisci una quantit√† valida');
                return;
            }

            const currentText = document.getElementById('ingredients-input').value;
            const newIngredient = `${ingredientName} ${quantity}g`;

            if (currentText.trim() === '') {
                document.getElementById('ingredients-input').value = newIngredient;
            } else {
                document.getElementById('ingredients-input').value = currentText + ', ' + newIngredient;
            }

            // Aggiorna storico
            addToHistory(ingredientName, quantity);

            // Aggiorna l'inventario dinamicamente se c'√® gi√† un piano generato
            if (fullPlan.length > 0) {
                const updatedIngredients = document.getElementById('ingredients-input').value;
                calculateIngredientConsumption(updatedIngredients);
                renderIngredientsTable();
                renderShoppingList();
            }

            alert(`‚úì ${ingredientName} (${quantity}g) aggiunto alla lista!\n\nL'inventario √® stato aggiornato automaticamente.`);
        };

        const renderShoppingListInModal = (filterText = '') => {
            const shoppingDiv = document.getElementById('shopping-items-modal');
            shoppingDiv.innerHTML = '';

            // Raccogli gli ingredienti dalla lista spesa
            const suggestedIngredients = new Map();

            fullPlan.forEach(week => {
                DAYS.forEach(day => {
                    const dayPlan = week[day];
                    if (!dayPlan) return;

                    MEALS.forEach(mealName => {
                        const meal = dayPlan[mealName];
                        if (!meal || !meal.items || meal.fromAvailable !== false) return;

                        meal.items.forEach(item => {
                            const name = item.name;
                            const qty = item.quantity || 0;

                            // NUOVO: Escludi gli ingredienti gi√† confermati
                            if (isIngredientConfirmed(name)) {
                                return;
                            }

                            if (suggestedIngredients.has(name)) {
                                suggestedIngredients.set(name, suggestedIngredients.get(name) + qty);
                            } else {
                                suggestedIngredients.set(name, qty);
                            }
                        });
                    });
                });
            });

            const sortedItems = Array.from(suggestedIngredients.entries())
                .sort((a, b) => a[0].localeCompare(b[0]))
                .filter(([name]) => name.toLowerCase().includes(filterText.toLowerCase()));

            if (sortedItems.length === 0) {
                shoppingDiv.innerHTML = '<p class="text-center text-gray-500 py-8">Nessun ingrediente da acquistare o genera prima un piano</p>';
                return;
            }

            const formatQty = (qty) => {
                if (qty >= 1000) return `${(qty / 1000).toFixed(2)} kg`;
                return `${Math.round(qty)} g`;
            };

            sortedItems.forEach(([name, suggestedQty]) => {
                const card = document.createElement('div');
                card.className = 'bg-orange-50 border border-orange-200 rounded-lg p-4 hover:bg-orange-100 transition-colors';
                card.innerHTML = `
                    <div class="flex items-center gap-3 mb-3">
                        <div class="flex-shrink-0 w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                            üõí
                        </div>
                        <div class="flex-1">
                            <div class="font-semibold text-gray-800 capitalize text-sm">${name}</div>
                            <div class="text-xs text-gray-600">Suggerito: <span class="font-mono font-bold text-orange-700">${formatQty(suggestedQty)}</span></div>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2">
                        <div class="flex items-center gap-2">
                            <input type="number" id="shop-qty-${name.replace(/\s+/g, '-')}" class="flex-1 px-3 py-2 border border-gray-300 rounded text-sm" placeholder="Quantit√†" value="${Math.round(suggestedQty)}">
                            <span class="text-sm text-gray-600 font-medium">g</span>
                        </div>
                        <button class="w-full px-4 py-2 bg-green-500 text-white text-sm font-semibold rounded hover:bg-green-600" onclick="markAsPurchased('${name}', '${name.replace(/\s+/g, '-')}')">
                            ‚úì Acquistato
                        </button>
                    </div>
                `;
                shoppingDiv.appendChild(card);
            });
        };

        window.markAsPurchased = (ingredientName, id, fromMainList = false) => {
            console.log(`\nüõí === CONFERMA INGREDIENTE DAL MODALE ===`);
            console.log(`   Ingrediente: "${ingredientName}"`);

            const qtyInput = document.getElementById(`shop-qty-${id}`);
            const quantity = parseInt(qtyInput.value) || 0;

            if (quantity <= 0) {
                alert('Inserisci una quantit√† valida');
                return;
            }

            console.log(`   Quantit√†: ${quantity}g`);

            const currentText = document.getElementById('ingredients-input').value;
            const newIngredient = `${ingredientName} ${quantity}g`;

            if (currentText.trim() === '') {
                document.getElementById('ingredients-input').value = newIngredient;
            } else {
                document.getElementById('ingredients-input').value = currentText + ', ' + newIngredient;
            }

            console.log(`   ‚úì Aggiunto alla lista ingredienti`);

            // Aggiorna storico
            addToHistory(ingredientName, quantity);
            console.log(`   ‚úì Salvato nello storico`);

            // NUOVO: Marca l'ingrediente come confermato
            addConfirmedIngredient(ingredientName);
            console.log(`   ‚úì Ingrediente marcato come confermato`);

            // Aggiorna l'inventario dinamicamente se c'√® gi√† un piano generato
            if (fullPlan.length > 0) {
                console.log(`\nüìä Ricalcolo inventario...`);
                const updatedIngredients = document.getElementById('ingredients-input').value;
                calculateIngredientConsumption(updatedIngredients);
                console.log(`   ‚úì Inventario aggiornato`);

                // DOPO aver aggiornato l'inventario, aggiorna i pasti
                console.log(`\nüçΩÔ∏è Aggiornamento pasti...`);
                updateMealsWithConfirmedIngredient(ingredientName);

                // Salva il piano aggiornato
                saveMealPlan(fullPlan);
                saveIngredientsInventory(ingredientsInventory);
                console.log(`   ‚úì Piano e inventario salvati`);

                // Aggiorna tutte le visualizzazioni
                console.log(`\nüîÑ Aggiornamento visualizzazioni...`);
                renderIngredientsTable();
                renderShoppingList();
                renderDayContent();

                // Aggiorna immediatamente la lista spesa nel modale se aperto
                if (!modal.classList.contains('hidden')) {
                    renderShoppingListInModal(document.getElementById('search-shopping')?.value || '');
                }

                console.log(`\n‚úÖ === CONFERMA COMPLETATA ===\n`);
            }

            // Rimuovi dalla vista con animazione solo se non dalla lista principale
            if (!fromMainList && qtyInput) {
                const cardElement = qtyInput.parentElement.parentElement;
                cardElement.style.transition = 'all 0.3s ease-out';
                cardElement.style.opacity = '0.5';
                cardElement.style.transform = 'scale(0.95)';

                const button = cardElement.querySelector('button');
                button.disabled = true;
                button.textContent = '‚úì Aggiunto';
                button.className = button.className.replace('bg-green-500', 'bg-gray-400');
            }

            // Feedback visivo
            alert(`‚úÖ ${ingredientName} (${quantity}g) acquistato!\n\nüì¶ Aggiunto all'inventario\nüîÑ Liste aggiornate\n‚ú® Pasti aggiornati automaticamente`);
        };

        // NUOVA FUNZIONE: Aggiorna i pasti che usano un ingrediente confermato
        const updateMealsWithConfirmedIngredient = (ingredientName) => {
            console.log(`üîç Cercando pasti con ingrediente: "${ingredientName}"`);
            console.log(`üîÑ Controllando TUTTI i pasti con ingredienti suggeriti...`);
            let updated = false;
            let mealsUpdated = 0;

            fullPlan.forEach((week, weekIdx) => {
                DAYS.forEach(day => {
                    const dayPlan = week[day];
                    if (!dayPlan) return;

                    MEALS.forEach(mealName => {
                        const meal = dayPlan[mealName];
                        if (!meal || !meal.items || meal.fromAvailable !== false) return;

                        // NUOVO: Controlla TUTTI i pasti, non solo quelli con l'ingrediente specifico
                        console.log(`   üìã Controllo: ${day} - ${mealName}`);

                        // Controlla se TUTTI gli ingredienti del pasto sono ora disponibili
                        const allAvailable = meal.items.every(item => {
                            // Cerca l'ingrediente nell'inventario usando il nome normalizzato
                            const normalizedName = normalizeIngredientName(item.name);
                            const isInInventory = ingredientsInventory[normalizedName] && ingredientsInventory[normalizedName].initial > 0;
                            const isConfirmed = isIngredientConfirmed(item.name);
                            const isAvailable = isInInventory || isConfirmed;

                            if (!isAvailable) {
                                console.log(`      ‚úó ${item.name} mancante`);
                            }

                            return isAvailable;
                        });

                        // Se tutti gli ingredienti sono disponibili, marca il pasto come fromAvailable: true
                        if (allAvailable) {
                            console.log(`   ‚úÖ TUTTI disponibili! Aggiornamento pasto da fromAvailable: false ‚Üí true`);
                            meal.fromAvailable = true;
                            updated = true;
                            mealsUpdated++;
                        }
                    });
                });
            });

            if (updated) {
                console.log(`‚úÖ ${mealsUpdated} pasti aggiornati dopo conferma di "${ingredientName}"`);
            } else {
                console.log(`‚ÑπÔ∏è Nessun pasto completato dopo conferma di "${ingredientName}"`);
            }

            return updated;
        };

        // NUOVA FUNZIONE: Conferma un ingrediente dalla lista della spesa principale
        window.confirmFromMainList = (ingredientName, safeId) => {
            console.log(`\nüõí === CONFERMA INGREDIENTE DALLA LISTA PRINCIPALE ===`);
            console.log(`   Ingrediente: "${ingredientName}"`);

            const qtyInput = document.getElementById(`main-qty-${safeId}`);
            const quantity = parseInt(qtyInput.value) || 0;

            if (quantity <= 0) {
                alert('Inserisci una quantit√† valida');
                return;
            }

            console.log(`   Quantit√†: ${quantity}g`);

            const currentText = document.getElementById('ingredients-input').value;
            const newIngredient = `${ingredientName} ${quantity}g`;

            if (currentText.trim() === '') {
                document.getElementById('ingredients-input').value = newIngredient;
            } else {
                document.getElementById('ingredients-input').value = currentText + ', ' + newIngredient;
            }

            console.log(`   ‚úì Aggiunto alla lista ingredienti`);

            // Aggiorna storico
            addToHistory(ingredientName, quantity);
            console.log(`   ‚úì Salvato nello storico`);

            // NUOVO: Marca l'ingrediente come confermato
            addConfirmedIngredient(ingredientName);
            console.log(`   ‚úì Ingrediente marcato come confermato`);

            // Aggiorna l'inventario PRIMA di controllare i pasti
            if (fullPlan.length > 0) {
                console.log(`\nüìä Ricalcolo inventario...`);
                const updatedIngredients = document.getElementById('ingredients-input').value;
                calculateIngredientConsumption(updatedIngredients);
                console.log(`   ‚úì Inventario aggiornato`);
                console.log(`   üì¶ Inventario corrente:`, ingredientsInventory);

                // DOPO aver aggiornato l'inventario, aggiorna i pasti
                console.log(`\nüçΩÔ∏è Aggiornamento pasti...`);
                const wasUpdated = updateMealsWithConfirmedIngredient(ingredientName);

                // Salva il piano aggiornato
                saveMealPlan(fullPlan);
                saveIngredientsInventory(ingredientsInventory);
                console.log(`   ‚úì Piano e inventario salvati`);

                // Aggiorna tutte le visualizzazioni
                console.log(`\nüîÑ Aggiornamento visualizzazioni...`);
                renderIngredientsTable();
                console.log(`   ‚úì Tabella ingredienti aggiornata`);

                renderShoppingList();
                console.log(`   ‚úì Lista spesa aggiornata`);

                renderDayContent();
                console.log(`   ‚úì Vista giorno corrente aggiornata`);

                console.log(`\n‚úÖ === CONFERMA COMPLETATA ===\n`);
            }

            // Feedback visivo
            alert(`‚úÖ ${ingredientName} (${quantity}g) confermato!\n\nüì¶ Aggiunto all'inventario\nüîÑ Liste aggiornate\n‚ú® Pasti aggiornati automaticamente`);
        };

        // ==============================================================================
        // 5B. FUNZIONI PER ORDINAMENTO E MODIFICA INVENTARIO
        // ==============================================================================

        window.sortInventory = (sortBy) => {
            // Toggle tra asc e desc se clicchiamo sulla stessa colonna
            if (inventorySortBy === sortBy) {
                inventorySortOrder = inventorySortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                inventorySortBy = sortBy;
                inventorySortOrder = 'asc';
            }

            // Aggiorna le icone
            ['name', 'initial', 'remaining', 'status'].forEach(col => {
                const icon = document.getElementById(`sort-icon-${col}`);
                if (icon) {
                    if (col === sortBy) {
                        icon.textContent = inventorySortOrder === 'asc' ? '‚Üë' : '‚Üì';
                        icon.classList.add('text-blue-600');
                    } else {
                        icon.textContent = '‚áÖ';
                        icon.classList.remove('text-blue-600');
                    }
                }
            });

            // Ri-renderizza la tabella
            renderIngredientsTable();
        };

        window.editIngredientQuantity = (ingredientName, safeId) => {
            // Mostra l'input e nascondi il testo
            document.getElementById(`view-${safeId}`).classList.add('hidden');
            document.getElementById(`edit-${safeId}`).classList.remove('hidden');

            // Mostra i pulsanti salva/annulla e nascondi il pulsante edit
            document.getElementById(`btn-edit-${safeId}`).classList.add('hidden');
            document.getElementById(`btn-save-${safeId}`).classList.remove('hidden');
            document.getElementById(`btn-cancel-${safeId}`).classList.remove('hidden');

            // Focus sull'input
            document.getElementById(`input-${safeId}`).focus();
            document.getElementById(`input-${safeId}`).select();
        };

        window.cancelEditIngredient = (safeId, originalValue) => {
            // Ripristina il valore originale
            document.getElementById(`input-${safeId}`).value = Math.round(originalValue);

            // Nascondi l'input e mostra il testo
            document.getElementById(`view-${safeId}`).classList.remove('hidden');
            document.getElementById(`edit-${safeId}`).classList.add('hidden');

            // Nascondi i pulsanti salva/annulla e mostra il pulsante edit
            document.getElementById(`btn-edit-${safeId}`).classList.remove('hidden');
            document.getElementById(`btn-save-${safeId}`).classList.add('hidden');
            document.getElementById(`btn-cancel-${safeId}`).classList.add('hidden');
        };

        window.saveIngredientQuantity = (ingredientName, safeId) => {
            const input = document.getElementById(`input-${safeId}`);
            const newQuantity = parseInt(input.value) || 0;

            if (newQuantity < 0) {
                alert('La quantit√† non pu√≤ essere negativa!');
                return;
            }

            console.log(`üíæ Aggiornamento quantit√†: "${ingredientName}" ‚Üí ${newQuantity}g`);

            // Aggiorna l'inventario
            const normalizedName = normalizeIngredientName(ingredientName);
            if (ingredientsInventory[normalizedName]) {
                const oldQuantity = ingredientsInventory[normalizedName].initial;
                ingredientsInventory[normalizedName].initial = newQuantity;
                console.log(`   Vecchia quantit√†: ${oldQuantity}g ‚Üí Nuova: ${newQuantity}g`);

                // Aggiorna anche la lista degli ingredienti nel textarea
                const currentText = document.getElementById('ingredients-input').value;
                const ingredients = currentText.split(',').map(s => s.trim());

                // Trova e aggiorna l'ingrediente nella lista
                const updatedIngredients = ingredients.map(item => {
                    const itemNormalized = normalizeIngredientName(item.split(/\d/)[0]);
                    if (itemNormalized === normalizedName) {
                        return `${ingredientName} ${newQuantity}g`;
                    }
                    return item;
                });

                document.getElementById('ingredients-input').value = updatedIngredients.join(', ');

                // Salva le modifiche
                saveIngredientsInventory(ingredientsInventory);
                console.log(`   ‚úì Inventario salvato`);

                // Ri-renderizza tutto
                renderIngredientsTable();
                renderShoppingList();
                renderDayContent();

                alert(`‚úÖ Quantit√† di "${ingredientName}" aggiornata a ${newQuantity}g!`);
            } else {
                alert(`‚ùå Errore: ingrediente "${ingredientName}" non trovato nell'inventario`);
            }
        };

        // ==============================================================================
        // 5C. GENERAZIONE RICETTE AI DEL GIORNO
        // ==============================================================================

        // Funzione per aprire il modal di selezione pasto
        window.generateDailyRecipes = () => {
            const apiKey = getApiKey();
            if (!apiKey) {
                alert('‚ö†Ô∏è Configura prima la tua API Key!\n\nVai in Impostazioni ‚öôÔ∏è e inserisci la tua chiave API di Google Gemini.');
                return;
            }

            const dayPlan = fullPlan?.[currentState.week]?.[currentState.day];
            if (!dayPlan || Object.keys(dayPlan).length === 0) {
                alert('‚ö†Ô∏è Nessun piano disponibile per questo giorno!');
                return;
            }

            // Apri il modal di selezione
            document.getElementById('meal-selection-modal').classList.remove('hidden');
        };

        // Funzione chiamata quando l'utente seleziona un pasto
        window.selectMealAndGenerate = async (mealType) => {
            // Chiudi il modal di selezione
            document.getElementById('meal-selection-modal').classList.add('hidden');

            const apiKey = getApiKey();
            const dayPlan = fullPlan?.[currentState.week]?.[currentState.day];

            // Raccogli gli ingredienti in base al tipo di pasto scelto
            const ingredientsList = [];
            const ingredientsSet = new Set();
            const mealsToInclude = mealType === 'lunch'
                ? ['Pranzo']
                : ['Cena'];

            MEALS.forEach(mealName => {
                if (!mealsToInclude.includes(mealName)) return;

                const meal = dayPlan[mealName];
                if (!meal || !meal.items) return;

                meal.items.forEach(item => {
                    const key = `${item.name}-${item.quantity}`;
                    if (!ingredientsSet.has(key)) {
                        ingredientsSet.add(key);
                        ingredientsList.push(`${item.name} (${item.quantity}g)`);
                    }
                });
            });

            if (ingredientsList.length === 0) {
                alert('‚ö†Ô∏è Nessun ingrediente trovato per questo giorno!');
                return;
            }

            // Apri il modal
            const modal = document.getElementById('recipes-modal');
            const loader = document.getElementById('recipes-loader');
            const content = document.getElementById('recipes-content');
            const dayInfo = document.getElementById('recipes-day-info');

            const dayName = translateDay(currentState.day);
            const mealTypeText = mealType === 'lunch' ? 'Pranzo üçù' : 'Cena üçΩÔ∏è';
            dayInfo.textContent = `${dayName} - ${mealTypeText} - ${ingredientsList.length} ingredienti disponibili`;

            modal.classList.remove('hidden');
            loader.classList.remove('hidden');
            content.innerHTML = '';

            try {
                // Prompt per l'AI (tradotto)
                const mealContextKey = mealType === 'lunch' ? 'recipePromptContext_lunch' : 'recipePromptContext_dinner';
                const mealContext = typeof t === 'function' ? t(mealContextKey) : (mealType === 'lunch'
                    ? 'per il pranzo (ricette pi√π leggere e adatte al mezzogiorno)'
                    : 'per la cena (ricette pi√π sostanziose e della sera)');

                const prompt = `${typeof t === 'function' ? t('recipePromptIntro') : 'Sei uno chef esperto e creativo. Ho i seguenti ingredienti disponibili oggi'} ${mealContext}:

${ingredientsList.join(', ')}

${typeof t === 'function' ? t('recipePromptRequest') : 'Per favore, crea 3-4 ricette originali e creative'} ${mealContext} ${typeof t === 'function' ? t('recipePromptUsing') : 'utilizzando questi ingredienti.'}
${typeof t === 'function' ? t('recipePromptImportant') : 'IMPORTANTE: Le ricette devono essere LOW-FODMAP e senza glutine (gluten-free).'}

${typeof t === 'function' ? t('recipePromptProvide') : 'Per ogni ricetta fornisci:'}
1. ${typeof t === 'function' ? t('recipePromptName') : '**Nome della ricetta** (creativo e appetitoso)'}
2. ${typeof t === 'function' ? t('recipePromptType') : '**Tipo di piatto** (antipasto, primo, secondo, dessert, etc.)'}
3. ${typeof t === 'function' ? t('recipePromptTime') : '**Tempo di preparazione**'}
4. ${typeof t === 'function' ? t('recipePromptDifficulty') : '**Difficolt√†** (Facile/Media/Difficile)'}
5. ${typeof t === 'function' ? t('recipePromptIngredients') : '**Ingredienti necessari** (dalla lista fornita + eventuali ingredienti base come sale, pepe, olio)'}
6. ${typeof t === 'function' ? t('recipePromptSteps') : '**Procedimento** (passaggi numerati e chiari)'}
7. ${typeof t === 'function' ? t('recipePromptTip') : '**Consiglio dello chef** (un piccolo suggerimento per rendere la ricetta speciale)'}

${typeof t === 'function' ? t('recipePromptFormat') : 'Formatta la risposta in modo chiaro e strutturato usando Markdown.'}
${typeof t === 'function' ? t('recipePromptCreative') : 'Sii creativo e proponi abbinamenti interessanti!'}`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: prompt }]
                        }],
                        generationConfig: {
                            temperature: 0.9,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 8192,
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                const recipesText = data.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!recipesText) {
                    throw new Error('Nessuna ricetta generata dall\'AI');
                }

                // Nascondi loader e mostra contenuto
                loader.classList.add('hidden');

                // Converti Markdown in HTML (basic)
                const htmlContent = convertMarkdownToHTML(recipesText);
                content.innerHTML = htmlContent;

                console.log('‚úÖ Ricette generate con successo!');

            } catch (error) {
                console.error('‚ùå Errore nella generazione ricette:', error);
                loader.classList.add('hidden');
                content.innerHTML = `
                    <div class="bg-red-50 border-2 border-red-300 rounded-lg p-6 text-center">
                        <p class="text-red-700 font-bold text-lg mb-2">‚ùå Errore nella generazione delle ricette</p>
                        <p class="text-red-600 text-sm">${error.message}</p>
                        <p class="text-gray-600 text-xs mt-4">Controlla la tua API Key nelle impostazioni</p>
                    </div>
                `;
            }
        };

        // Helper function per convertire Markdown in HTML (basic)
        const convertMarkdownToHTML = (markdown) => {
            let html = markdown;

            // Headers
            html = html.replace(/^### (.*$)/gim, '<h3 class="text-xl font-bold text-gray-800 mt-6 mb-3">$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2 class="text-2xl font-bold text-purple-600 mt-8 mb-4 pb-2 border-b-2 border-purple-200">$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1 class="text-3xl font-bold text-gray-900 mt-6 mb-4">$1</h1>');

            // Bold
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-gray-800">$1</strong>');

            // Italic
            html = html.replace(/\*(.*?)\*/g, '<em class="italic">$1</em>');

            // Lists
            html = html.replace(/^\* (.*$)/gim, '<li class="ml-6 mb-2 text-gray-700">‚Ä¢ $1</li>');
            html = html.replace(/^\d+\. (.*$)/gim, '<li class="ml-6 mb-2 text-gray-700"><span class="font-semibold text-purple-600">$&</span></li>');

            // Line breaks
            html = html.replace(/\n\n/g, '</p><p class="text-gray-700 leading-relaxed mb-4">');
            html = '<p class="text-gray-700 leading-relaxed mb-4">' + html + '</p>';

            // Wrap in container
            html = `<div class="prose max-w-none">${html}</div>`;

            return html;
        };

        // ==============================================================================
        // 6. INIZIALIZZAZIONE E EVENTI
        // ==============================================================================
        const modal = document.getElementById('ingredients-modal');
        const openModalBtn = document.getElementById('open-modal-btn');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const generateWithAIBtn = document.getElementById('generate-with-ai-btn');
        const ingredientsInput = document.getElementById('ingredients-input');
        const saveListBtn = document.getElementById('save-list-btn');
        const listNameInput = document.getElementById('list-name-input');

        openModalBtn.addEventListener('click', () => {
            modal.classList.remove('hidden');
            renderSavedLists();
            renderIngredientsHistory();
            renderShoppingListInModal();
        });

        closeModalBtn.addEventListener('click', () => modal.classList.add('hidden'));

        saveListBtn.addEventListener('click', () => {
            const ingredients = ingredientsInput.value.trim();
            if (!ingredients) {
                alert('Inserisci prima degli ingredienti!');
                return;
            }

            let listName = listNameInput.value.trim();
            if (!listName) {
                listName = `Lista ${new Date().toLocaleDateString('it-IT')}`;
            }

            const lists = loadSavedLists();
            lists[listName] = ingredients;
            saveLists(lists);

            listNameInput.value = '';
            renderSavedLists();
            alert(`Lista "${listName}" salvata con successo!`);
        });

        generateWithAIBtn.addEventListener('click', () => {
            const ingredients = ingredientsInput.value;
            if (ingredients.trim() === '') {
                alert('Per favore, inserisci almeno un ingrediente.');
                return;
            }
            // Salva gli ingredienti nello storico
            updateCurrentIngredients(ingredients);
            modal.classList.add('hidden');
            generateMealsWithAI(ingredients);
        });

        // Gestione modal ricette AI
        const recipesModal = document.getElementById('recipes-modal');
        const closeRecipesBtn = document.getElementById('close-recipes-btn');

        closeRecipesBtn.addEventListener('click', () => {
            recipesModal.classList.add('hidden');
        });

        // Chiudi anche cliccando fuori dal modal
        recipesModal.addEventListener('click', (e) => {
            if (e.target === recipesModal) {
                recipesModal.classList.add('hidden');
            }
        });

        // Gestione tab modale
        const tabs = {
            manual: document.getElementById('tab-manual'),
            history: document.getElementById('tab-history'),
            shopping: document.getElementById('tab-shopping')
        };

        const contents = {
            manual: document.getElementById('content-manual'),
            history: document.getElementById('content-history'),
            shopping: document.getElementById('content-shopping')
        };

        const switchTab = (activeTab) => {
            Object.keys(tabs).forEach(key => {
                if (key === activeTab) {
                    tabs[key].classList.remove('border-transparent', 'text-gray-500');
                    tabs[key].classList.add('border-blue-500', 'text-blue-600');
                    contents[key].classList.remove('hidden');
                } else {
                    tabs[key].classList.remove('border-blue-500', 'text-blue-600');
                    tabs[key].classList.add('border-transparent', 'text-gray-500');
                    contents[key].classList.add('hidden');
                }
            });
        };

        tabs.manual.addEventListener('click', () => switchTab('manual'));
        tabs.history.addEventListener('click', () => {
            switchTab('history');
            renderIngredientsHistory();
        });
        tabs.shopping.addEventListener('click', () => {
            switchTab('shopping');
            renderShoppingListInModal();
        });

        // Filtri di ricerca con debouncing per performance
        const debouncedHistorySearch = debounce((value) => {
            renderIngredientsHistory(value);
        }, 300);

        const debouncedShoppingSearch = debounce((value) => {
            renderShoppingListInModal(value);
        }, 300);

        document.getElementById('search-history').addEventListener('input', (e) => {
            debouncedHistorySearch(e.target.value);
        });

        document.getElementById('search-shopping').addEventListener('input', (e) => {
            debouncedShoppingSearch(e.target.value);
        });

        // Cancella storico
        document.getElementById('clear-history-btn').addEventListener('click', () => {
            if (confirm('Sei sicuro di voler cancellare tutto lo storico degli ingredienti?')) {
                localStorage.removeItem(HISTORY_KEY);
                renderIngredientsHistory();
                alert('Storico cancellato!');
            }
        });

        // NUOVO: Pulsante refresh inventario
        document.getElementById('refresh-inventory-btn').addEventListener('click', () => {
            console.log('üîÑ Refresh inventario richiesto dall\'utente');
            if (fullPlan.length === 0) {
                alert('‚ö†Ô∏è Nessun piano alimentare caricato!\n\nGenera prima un piano alimentare.');
                return;
            }

            // Ricalcola l'inventario dal piano attuale
            const currentIngredients = document.getElementById('ingredients-input').value;
            calculateIngredientConsumption(currentIngredients);

            // Ri-renderizza
            renderIngredientsTable();
            renderShoppingList();

            alert('‚úÖ Inventario aggiornato!\n\nMostra tutti gli ingredienti usati nel piano.');
        });

        // Gestione API Key modal
        const apiKeyModal = document.getElementById('api-key-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const openSettingsBtn = document.getElementById('open-settings-btn');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const cancelApiKeyBtn = document.getElementById('cancel-api-key-btn');
        const toggleApiKeyVisibilityBtn = document.getElementById('toggle-api-key-visibility');

        openSettingsBtn.addEventListener('click', () => {
            // Carica i valori salvati nei campi del form
            const currentKey = getApiKey();
            const userName = getUserName();
            const dailyCalories = getDailyCalories();

            if (currentKey) {
                apiKeyInput.value = currentKey;
            }
            document.getElementById('user-name-input').value = userName;
            document.getElementById('daily-calories-input').value = dailyCalories;

            apiKeyModal.classList.remove('hidden');
        });

        saveApiKeyBtn.addEventListener('click', () => {
            const key = apiKeyInput.value.trim();
            const userName = document.getElementById('user-name-input').value.trim();
            const dailyCalories = parseInt(document.getElementById('daily-calories-input').value);

            // Validazione API Key
            if (!key) {
                alert('Inserisci una API Key valida!');
                return;
            }
            if (!key.startsWith('AIza')) {
                alert('‚ö†Ô∏è La API Key sembra non valida.\nLe chiavi di Google AI Studio iniziano con "AIza".\n\nSe sei sicuro, premi di nuovo Salva.');
                return;
            }

            // Validazione nome utente
            if (!userName) {
                alert('‚ö†Ô∏è Inserisci un nome utente!');
                return;
            }

            // Validazione calorie
            if (!dailyCalories || dailyCalories < 1000 || dailyCalories > 3000) {
                alert('‚ö†Ô∏è Le calorie giornaliere devono essere tra 1000 e 3000!');
                return;
            }

            // Salva tutte le impostazioni
            saveApiKey(key);
            saveUserName(userName);
            saveDailyCalories(dailyCalories);

            // Aggiorna il nome nel titolo
            updateUserNameDisplay();

            apiKeyModal.classList.add('hidden');
            alert('‚úÖ Impostazioni salvate correttamente!\n\nüë§ Nome: ' + userName + '\nüî• Calorie: ' + dailyCalories + ' kcal/giorno\n\nOra puoi generare i tuoi piani alimentari personalizzati.');
        });

        cancelApiKeyBtn.addEventListener('click', () => {
            apiKeyModal.classList.add('hidden');
            apiKeyInput.value = '';
        });

        toggleApiKeyVisibilityBtn.addEventListener('click', () => {
            const showHideText = document.getElementById('show-hide-text');
            if (apiKeyInput.type === 'password') {
                apiKeyInput.type = 'text';
                const hideText = typeof t === 'function' ? t('apiKeyHide') : 'Nascondi';
                showHideText.innerHTML = `üôà <span data-i18n="apiKeyHide">${hideText}</span>`;
            } else {
                apiKeyInput.type = 'password';
                const showText = typeof t === 'function' ? t('apiKeyShow') : 'Mostra';
                showHideText.innerHTML = `üëÅÔ∏è <span data-i18n="apiKeyShow">${showText}</span>`;
            }
        });

        // Toggle lista della spesa
        document.getElementById('toggle-shopping-btn').addEventListener('click', function() {
            const content = document.getElementById('shopping-list-content');
            const btn = this;
            if (content.style.display === 'none') {
                content.style.display = 'block';
                const hideText = typeof t === 'function' ? t('hide') : 'Nascondi';
                btn.innerHTML = `<span data-i18n="hide">${hideText}</span> ‚ñ≤`;
            } else {
                content.style.display = 'none';
                const showText = typeof t === 'function' ? t('show') : 'Mostra';
                btn.innerHTML = `<span data-i18n="show">${showText}</span> ‚ñº`;
            }
        });

        // Toggle tabella ingredienti
        document.getElementById('toggle-table-btn').addEventListener('click', function() {
            const content = document.getElementById('ingredients-table-content');
            const btn = this;
            if (content.style.display === 'none') {
                content.style.display = 'block';
                const hideText = typeof t === 'function' ? t('hide') : 'Nascondi';
                btn.innerHTML = `<span data-i18n="hide">${hideText}</span> ‚ñ≤`;
            } else {
                content.style.display = 'none';
                const showText = typeof t === 'function' ? t('show') : 'Mostra';
                btn.innerHTML = `<span data-i18n="show">${showText}</span> ‚ñº`;
            }
        });
        
        // Lista di esempio ingredienti
        const EXAMPLE_INGREDIENTS = "tomini con speck 195g, purea una busta, polpa di pomodoro qb., semi di canapa 180g, cotechino 2, pan grattato senza glutine 500g, funghi misti secchi 15g, lenticchie secche 150g, pasta senza glutine 2kg, quinoa secca 190g, danacol 6, cotto snack 56g, uova 6, mini burrate 3 da 65g, bottarga 30g, pecorino stagionato 200g, panna cotta 500g, battuta di fassona 4 da 100g, braciola di lonza di suino 200g, popette di suino 300g, pancetta a fette 98g, pollo arrosto a fette 110g, hamburgher di bovino 240g, Filadelfia 4 da 35g, sottilette q.b., latte 1l, gorgonzola 300g, purea di mela e pera 4 da 100g, danet 6 da 125g, pizza senza glutine 1, lasagne senza glutine 1, calzone senza glutine e senza lattosio 1, passato di verdura 600g, rosti di patate 400g, rombo 360g, tentatoli di totano 250g, funghi porcini, gnocchi ripieni senza glutine 350g, pane senza glutine 5 panini, chicken finger senza glutine 50g, zucca 1, limoni 4, patate 6, pomodorini ciliegia 250g, una carota, mele 1kg, pan di zucchero 1";

        // Pulsante carica esempio
        document.getElementById('load-example-btn').addEventListener('click', () => {
            if (ingredientsInput.value.trim() && !confirm('Vuoi sostituire gli ingredienti correnti con l\'esempio?')) {
                return;
            }
            ingredientsInput.value = EXAMPLE_INGREDIENTS;
        });

        // Pulsante cancella piano salvato
        document.getElementById('clear-plan-btn').addEventListener('click', () => {
            const confirmMessage = typeof t === 'function' ? t('confirmClearPlan') : 'Sei sicuro di voler cancellare il piano alimentare salvato?\n\nQuesta azione non pu√≤ essere annullata.';
            if (confirm(confirmMessage)) {
                clearMealPlan();
                fullPlan = [];
                ingredientsInventory = {};
                renderUI();
                renderIngredientsTable();
                renderShoppingList();
                const successMessage = typeof t === 'function' ? t('planCleared') : '‚úÖ Piano alimentare cancellato! Puoi generarne uno nuovo.';
                alert(successMessage);
            }
        });

        // Event listeners per i modal delle ricette
        document.getElementById('close-meal-selection-btn').addEventListener('click', () => {
            document.getElementById('meal-selection-modal').classList.add('hidden');
        });

        document.getElementById('close-recipes-btn').addEventListener('click', () => {
            document.getElementById('recipes-modal').classList.add('hidden');
        });

        // Funzione di condivisione ricette
        document.getElementById('share-recipes-btn').addEventListener('click', () => {
            const content = document.getElementById('recipes-content');
            const dayInfo = document.getElementById('recipes-day-info').textContent;

            if (!content || !content.textContent.trim()) {
                alert('‚ö†Ô∏è Nessuna ricetta da condividere!');
                return;
            }

            // Prendi il testo delle ricette (rimuovi HTML)
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content.innerHTML;
            const recipesText = tempDiv.textContent || tempDiv.innerText || '';

            // Crea il testo da condividere
            const shareText = `üçΩÔ∏è ${dayInfo}\n\n${recipesText}\n\nü§ñ Generato con Piano Alimentare AI`;

            // Prova a usare l'API Web Share (mobile)
            if (navigator.share) {
                navigator.share({
                    title: 'üçΩÔ∏è Ricette AI',
                    text: shareText
                }).then(() => {
                    console.log('‚úÖ Ricette condivise!');
                }).catch((error) => {
                    console.log('Condivisione annullata:', error);
                });
            } else {
                // Fallback: copia negli appunti
                navigator.clipboard.writeText(shareText).then(() => {
                    alert('‚úÖ Ricette copiate negli appunti!\n\nPuoi incollarle dove vuoi.');
                }).catch((error) => {
                    console.error('Errore copia:', error);
                    alert('‚ùå Impossibile copiare le ricette negli appunti.');
                });
            }
        });

        // Update user name in title
        const updateUserNameDisplay = () => {
            const userNameDisplay = document.getElementById('user-name-display');
            const userName = getUserName();
            if (userNameDisplay) {
                userNameDisplay.textContent = userName;
            }
            // Aggiorna anche il title della pagina
            document.title = `Piano Alimentare AI - ${userName}`;
        };

        // Update language buttons
        const updateLanguageButtons = () => {
            const langIt = document.getElementById('lang-it');
            const langEn = document.getElementById('lang-en');

            if (currentLang === 'it') {
                langIt.classList.add('active');
                langEn.classList.remove('active');
            } else {
                langEn.classList.add('active');
                langIt.classList.remove('active');
            }
        };

        // Avvio iniziale
        window.onload = () => {
            // Campo ingredienti vuoto all'inizio
            ingredientsInput.value = '';

            // Initialize language
            updateLanguageButtons();

            // Aggiorna il nome utente nel titolo
            updateUserNameDisplay();

            // Carica il piano salvato se esiste
            const savedPlan = loadMealPlan();
            if (savedPlan && savedPlan.length > 0) {
                fullPlan = savedPlan;
                console.log('üì¶ Piano alimentare ripristinato da localStorage');

                // Carica anche l'inventario salvato
                const savedInventory = loadIngredientsInventory();
                if (savedInventory && Object.keys(savedInventory).length > 0) {
                    ingredientsInventory = savedInventory;
                    console.log('üì¶ Inventario ingredienti ripristinato');
                }

                // Renderizza l'interfaccia con i dati caricati
                renderUI();
                renderIngredientsTable();
                renderShoppingList();
            } else {
                // Nessun piano salvato, mostra interfaccia vuota
                renderUI();
            }

            // Verifica se l'API Key √® configurata
            if (!getApiKey()) {
                setTimeout(() => {
                    apiKeyModal.classList.remove('hidden');
                }, 500);
            }

            // Registra Service Worker per PWA
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then((registration) => {
                            console.log('‚úÖ Service Worker registrato:', registration.scope);
                        })
                        .catch((error) => {
                            console.log('‚ùå Registrazione Service Worker fallita:', error);
                        });
                });
            }
        };
    </script>

    <!-- Internationalization (i18n) -->
    <script src="./i18n.js"></script>

    <!-- Features aggiuntive: Rigenerazione pasto e Stampa PDF -->
    <script src="./features_addon.js"></script>
</body>
</html>

